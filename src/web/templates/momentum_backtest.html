{% extends "base.html" %}

{% block title %}动量板块策略{% endblock %}

{% block content %}
<div class="momentum-page">
    <h2>动量板块策略</h2>

    <!-- Monitor Status -->
    <section class="momentum-section">
        <div class="monitor-card">
            <div class="monitor-header">
                <h3>盘中监控</h3>
                <span id="monitor-status" class="status-indicator {{ 'running' if monitor_running else 'stopped' }}">
                    {{ '运行中' if monitor_running else '已停止' }}
                </span>
            </div>
            <p class="monitor-desc">每个交易日 9:30-9:40 自动追踪涨幅 >5% 主板非ST股票，选股后飞书通知</p>
            <div id="monitor-last-result"></div>
        </div>
    </section>

    <!-- Backtest Tabs -->
    <section class="momentum-section">
        <div class="sim-card">
            <div class="backtest-tabs">
                <button class="backtest-tab active" data-tab="single">单日回测</button>
                <button class="backtest-tab" data-tab="combined">区间分析</button>
            </div>

            <!-- Single Day Backtest -->
            <div id="tab-single" class="tab-content">
                <form id="backtest-form" class="sim-form">
                    <div class="form-group">
                        <label for="trade_date">回测日期</label>
                        <input type="date" id="trade_date" name="trade_date" required>
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify" name="notify">
                            <span>同时发送飞书通知</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" id="backtest-btn">开始回测</button>
                </form>
            </div>

            <!-- Combined Analysis (range backtest + funnel) -->
            <div id="tab-combined" class="tab-content hidden">
                <form id="combined-form" class="sim-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="combined_start">起始日期</label>
                            <input type="date" id="combined_start" name="combined_start" required>
                        </div>
                        <div class="form-group">
                            <label for="combined_end">结束日期</label>
                            <input type="date" id="combined_end" name="combined_end" required>
                        </div>
                        <div class="form-group">
                            <label for="combined_capital">起始资金 (元)</label>
                            <input type="number" id="combined_capital" name="combined_capital"
                                   value="100000" min="1000" step="1000" required>
                        </div>
                    </div>
                    <p class="form-hint">综合分析：逐日运行选股漏斗 + 资金模拟回测。9:40 买入推荐股，次日开盘卖出。最多 90 个交易日。含手续费。</p>
                    <button type="submit" class="btn btn-primary" id="combined-btn">开始区间分析</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Backfill & CSV Export -->
    <section class="momentum-section">
        <div class="sim-card">
            <h3>选股数据回填 & 导出</h3>
            <p class="form-hint">回填历史选股候选池（Step 5.6 之后、推荐之前），含价格、次日收益、业绩增长率。支持断点续填。</p>
            <form id="backfill-form" class="sim-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="bf_start">起始日期</label>
                        <input type="date" id="bf_start" name="bf_start" required>
                    </div>
                    <div class="form-group">
                        <label for="bf_end">结束日期</label>
                        <input type="date" id="bf_end" name="bf_end" required>
                    </div>
                </div>
                <div class="form-row" style="gap:8px">
                    <button type="submit" class="btn btn-primary" id="backfill-btn">开始回填</button>
                    <button type="button" class="btn btn-primary" id="csv-export-btn" style="background:#2563eb">下载 CSV</button>
                </div>
            </form>
            <p id="backfill-error" style="color:#dc2626;display:none"></p>
            <!-- Backfill progress -->
            <div id="backfill-progress" style="display:none;margin-top:12px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                    <div class="loading-spinner" style="width:16px;height:16px;border-width:2px"></div>
                    <span id="bf-status">准备中...</span>
                </div>
                <div style="background:#e5e7eb;border-radius:4px;height:8px;overflow:hidden">
                    <div id="bf-bar" style="background:#10b981;height:100%;width:0%;transition:width 0.3s"></div>
                </div>
                <pre id="bf-log" style="max-height:200px;overflow-y:auto;font-size:12px;margin-top:8px;padding:8px;background:#f9fafb;border-radius:4px"></pre>
            </div>
        </div>
    </section>

    <!-- Single Day Loading -->
    <section id="loading-section" class="momentum-section hidden">
        <div class="sim-card loading-card">
            <div class="loading-spinner"></div>
            <p>回测运行中，正在查询 iFinD 数据...</p>
            <p class="loading-hint">Step 1: iwencai 查询初筛 → Step 2: 反查概念板块 → Step 3: 热门板块 → Step 4: 成分股 → Step 5: PE过滤 → Step 6: 推股</p>
        </div>
    </section>

    <!-- Single Day Results -->
    <section id="results-section" class="momentum-section hidden">
        <div class="sim-card">
            <div class="result-header">
                <h3>回测结果 <span id="result-date"></span></h3>
                <div class="result-summary">
                    <span class="result-badge">初筛: <strong id="result-gainers">0</strong> 只</span>
                    <span class="result-badge">热门板块: <strong id="result-boards">0</strong> 个</span>
                    <span class="result-badge highlight">选股: <strong id="result-selected">0</strong> 只</span>
                    <span class="result-badge recommend" id="result-recommend-badge" style="display:none">
                        推股: <strong id="result-recommend-name"></strong>
                    </span>
                </div>
            </div>

            <!-- Recommendation card -->
            <div id="recommend-card" class="recommend-card hidden">
                <div class="recommend-label">推荐</div>
                <div class="recommend-body">
                    <div class="recommend-stock">
                        <span class="recommend-code" id="rec-code"></span>
                        <span class="recommend-stock-name" id="rec-name"></span>
                    </div>
                    <div class="recommend-details">
                        <span class="recommend-detail" id="rec-growth"></span>
                        <span class="recommend-detail" id="rec-gain"></span>
                        <span class="recommend-detail" id="rec-board"></span>
                    </div>
                </div>
            </div>

            <div id="result-empty" class="result-empty hidden">
                <p>未筛选到符合条件的股票</p>
            </div>

            <div id="result-boards-container"></div>
        </div>
    </section>

    <!-- Combined Analysis Loading -->
    <section id="combined-loading" class="momentum-section hidden">
        <div class="sim-card loading-card">
            <div class="loading-spinner"></div>
            <p id="combined-progress-text">正在处理...</p>
            <div class="range-progress-bar">
                <div id="combined-progress-fill" class="range-progress-fill"></div>
            </div>
            <p class="loading-hint" id="combined-progress-hint"></p>
        </div>
    </section>

    <!-- Combined Analysis Results -->
    <section id="combined-results" class="momentum-section hidden">
        <div class="sim-card">
            <h3>区间分析结果</h3>

            <!-- Backtest Summary -->
            <div id="combined-backtest-summary" class="range-summary"></div>

            <!-- Funnel Summary Table -->
            <div class="range-table-wrap">
                <table class="stock-table funnel-table">
                    <thead>
                        <tr>
                            <th>层级</th>
                            <th>平均股数</th>
                            <th>平均次日收益</th>
                            <th>胜率</th>
                            <th>中位收益</th>
                            <th>层级效果</th>
                        </tr>
                    </thead>
                    <tbody id="combined-funnel-summary-body"></tbody>
                </table>
            </div>

            <!-- Conclusions -->
            <div id="combined-conclusions" class="funnel-conclusions"></div>

            <!-- Trade Table -->
            <div class="range-table-wrap">
                <table class="stock-table range-table">
                    <thead>
                        <tr>
                            <th>买入日</th>
                            <th>推荐股</th>
                            <th>板块</th>
                            <th>买入价</th>
                            <th>卖出日</th>
                            <th>卖出价</th>
                            <th>手数</th>
                            <th>盈亏</th>
                            <th>收益率</th>
                            <th>当前资金</th>
                        </tr>
                    </thead>
                    <tbody id="combined-trade-body"></tbody>
                </table>
            </div>

            <!-- Per-day funnel detail (collapsible) -->
            <details class="funnel-details">
                <summary>逐日漏斗明细</summary>
                <div class="range-table-wrap">
                    <table class="stock-table funnel-day-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>L0 成分股</th>
                                <th>L1 涨幅</th>
                                <th>L2 动量质量</th>
                                <th>L3 冲高回落</th>
                                <th>L4 推荐</th>
                            </tr>
                        </thead>
                        <tbody id="combined-funnel-day-body"></tbody>
                    </table>
                </div>
            </details>

            <!-- Filtered-out best stocks -->
            <div id="combined-filtered-out" class="funnel-filtered-out"></div>

            <!-- Loss Analysis Button -->
            <div id="combined-loss-trigger" class="loss-analysis-trigger hidden">
                <button id="combined-loss-btn" class="btn btn-loss-analysis" onclick="startCombinedLossAnalysis()">
                    亏损分析 (<span id="combined-loss-count">0</span>笔)
                </button>
            </div>
        </div>
    </section>

    <!-- Loss Analysis Results -->
    <section id="loss-analysis-section" class="momentum-section hidden">
        <div class="sim-card">
            <h3>亏损分析</h3>

            <!-- Progress -->
            <div id="loss-analysis-progress" class="loss-progress hidden">
                <div class="loading-spinner-sm"></div>
                <span id="loss-progress-text">正在分析...</span>
            </div>

            <!-- Per-stock analysis cards -->
            <div id="loss-analysis-results"></div>

            <!-- Strategy summary -->
            <div id="loss-analysis-summary" class="hidden"></div>
        </div>
    </section>

    <!-- History (today's monitor results) -->
    <section id="history-section" class="momentum-section">
        <div class="sim-card">
            <h3>今日监控记录</h3>
            <div id="history-container">
                <p class="empty-hint">暂无记录</p>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// === Combined Results Store (for loss analysis) ===
let combinedResults = [];

// === Tab Switching ===
document.querySelectorAll('.backtest-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.backtest-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById('tab-' + target).classList.remove('hidden');

        // Only hide loading spinners of non-active tabs; keep result sections visible
        if (target === 'single') {
            document.getElementById('combined-loading').classList.add('hidden');
        } else {
            document.getElementById('loading-section').classList.add('hidden');
        }
    });
});

// === Single Day Backtest ===
document.getElementById('backtest-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const tradeDate = document.getElementById('trade_date').value;
    const notify = document.getElementById('notify').checked;

    if (!tradeDate) return;

    document.getElementById('loading-section').classList.remove('hidden');
    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('backtest-btn').disabled = true;
    document.getElementById('backtest-btn').textContent = '运行中...';

    try {
        const resp = await fetch('/api/momentum/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trade_date: tradeDate, notify: notify }),
        });

        const data = await resp.json();

        if (!resp.ok) {
            alert(data.detail || '回测失败');
            return;
        }

        renderResults(data);
    } catch (err) {
        alert('请求失败: ' + err.message);
    } finally {
        document.getElementById('loading-section').classList.add('hidden');
        document.getElementById('backtest-btn').disabled = false;
        document.getElementById('backtest-btn').textContent = '开始回测';
    }
});

function renderResults(data) {
    document.getElementById('results-section').classList.remove('hidden');
    document.getElementById('result-date').textContent = data.trade_date;
    document.getElementById('result-gainers').textContent = data.initial_gainers;
    document.getElementById('result-boards').textContent = Object.keys(data.hot_boards || {}).length;
    document.getElementById('result-selected').textContent = (data.selected_stocks || []).length;

    const container = document.getElementById('result-boards-container');
    const emptyEl = document.getElementById('result-empty');
    const recBadge = document.getElementById('result-recommend-badge');
    const recCard = document.getElementById('recommend-card');

    const rec = data.recommended_stock;
    if (rec) {
        recBadge.style.display = '';
        document.getElementById('result-recommend-name').textContent = `${rec.stock_name}`;
        recCard.classList.remove('hidden');
        document.getElementById('rec-code').textContent = rec.stock_code;
        document.getElementById('rec-name').textContent = rec.stock_name;
        document.getElementById('rec-growth').textContent = `业绩增长: ${rec.growth_rate >= 0 ? '+' : ''}${rec.growth_rate.toFixed(1)}%`;
        document.getElementById('rec-gain').textContent = `开盘涨幅: +${rec.open_gain_pct.toFixed(2)}%`;
        document.getElementById('rec-board').textContent = `板块: ${rec.board_name} (选出${rec.board_stock_count}只最多)`;
    } else {
        recBadge.style.display = '';
        document.getElementById('result-recommend-name').textContent = '无';
        recCard.classList.remove('hidden');
        document.getElementById('rec-code').textContent = '--';
        document.getElementById('rec-name').textContent = '今日无推荐标的';
        document.getElementById('rec-growth').textContent = '';
        document.getElementById('rec-gain').textContent = '';
        document.getElementById('rec-board').textContent = '池中无股票通过评分筛选';
    }

    if (!data.selected_stocks || data.selected_stocks.length === 0) {
        container.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
    }

    emptyEl.classList.add('hidden');

    const boardMap = {};
    data.selected_stocks.forEach(s => {
        if (!boardMap[s.board_name]) boardMap[s.board_name] = [];
        boardMap[s.board_name].push(s);
    });

    let html = '';
    for (const [boardName, stocks] of Object.entries(boardMap)) {
        const triggerCodes = (data.hot_boards[boardName] || []).join(', ');
        html += `
            <div class="board-group">
                <div class="board-header">
                    <span class="board-name">${boardName}</span>
                    <span class="board-trigger">触发: ${triggerCodes}</span>
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>代码</th>
                            <th>名称</th>
                            <th>开盘涨幅</th>
                            <th>PE(TTM)</th>
                            <th>板块均值PE</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        stocks.forEach(s => {
            const gainClass = s.open_gain_pct > 3 ? 'gain-high' : (s.open_gain_pct > 1 ? 'gain-mid' : 'gain-low');
            const isRec = rec && s.stock_code === rec.stock_code;
            html += `
                        <tr class="${isRec ? 'recommended-row' : ''}">
                            <td class="stock-code">${s.stock_code}</td>
                            <td>${s.stock_name}${isRec ? ' <span class="rec-tag">推荐</span>' : ''}</td>
                            <td class="${gainClass}">+${s.open_gain_pct.toFixed(2)}%</td>
                            <td>${s.pe_ttm.toFixed(1)}</td>
                            <td>${s.board_avg_pe.toFixed(1)}</td>
                        </tr>
            `;
        });
        html += '</tbody></table></div>';
    }

    container.innerHTML = html;
}

// === Combined Analysis ===
const LAYER_NAMES = ['L0: 全部成分股', 'L1: 涨幅>0.56%', 'L2: 动量质量过滤', 'L3: 冲高回落过滤', 'L4: 最终推荐'];

document.getElementById('combined-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const startDate = document.getElementById('combined_start').value;
    const endDate = document.getElementById('combined_end').value;
    const initialCapital = parseFloat(document.getElementById('combined_capital').value);

    if (!startDate || !endDate) return;
    if (endDate <= startDate) { alert('结束日期必须晚于起始日期'); return; }
    if (initialCapital < 1000) { alert('起始资金不能低于 1000 元'); return; }

    // Reset UI
    combinedResults = [];
    document.getElementById('combined-loading').classList.remove('hidden');
    document.getElementById('combined-results').classList.add('hidden');
    document.getElementById('combined-trade-body').innerHTML = '';
    document.getElementById('combined-backtest-summary').innerHTML = '';
    document.getElementById('combined-funnel-summary-body').innerHTML = '';
    document.getElementById('combined-funnel-day-body').innerHTML = '';
    document.getElementById('combined-conclusions').innerHTML = '';
    document.getElementById('combined-filtered-out').innerHTML = '';
    document.getElementById('combined-loss-trigger').classList.add('hidden');
    document.getElementById('loss-analysis-section').classList.add('hidden');
    document.getElementById('combined-btn').disabled = true;
    document.getElementById('combined-btn').textContent = '运行中...';

    try {
        const resp = await fetch('/api/momentum/combined-analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start_date: startDate,
                end_date: endDate,
                initial_capital: initialCapital,
            }),
        });

        if (!resp.ok) {
            const errData = await resp.json();
            alert(errData.detail || '分析失败');
            return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const messages = buffer.split('\n\n');
            buffer = messages.pop();

            for (const msg of messages) {
                const trimmed = msg.trim();
                if (!trimmed.startsWith('data: ')) continue;
                try {
                    const data = JSON.parse(trimmed.substring(6));
                    handleCombinedEvent(data);
                } catch (parseErr) {}
            }
        }

        if (buffer.trim().startsWith('data: ')) {
            try {
                const data = JSON.parse(buffer.trim().substring(6));
                handleCombinedEvent(data);
            } catch (e) {}
        }

    } catch (err) {
        alert('请求失败: ' + err.message);
    } finally {
        document.getElementById('combined-loading').classList.add('hidden');
        document.getElementById('combined-btn').disabled = false;
        document.getElementById('combined-btn').textContent = '开始区间分析';
    }
});

function handleCombinedEvent(data) {
    switch (data.type) {
        case 'init':
            document.getElementById('combined-progress-hint').textContent =
                `${data.start_date} ~ ${data.end_date}，共 ${data.total_days} 个交易日`;
            break;

        case 'warning':
            document.getElementById('combined-progress-hint').textContent = data.message;
            break;

        case 'progress': {
            document.getElementById('combined-progress-text').textContent =
                `正在处理第 ${data.day} / ${data.total} 天 (${data.trade_date})...`;
            const pct = (data.day / data.total * 100).toFixed(0);
            document.getElementById('combined-progress-fill').style.width = pct + '%';
            break;
        }

        case 'day_result': {
            document.getElementById('combined-results').classList.remove('hidden');
            // Backtest trade row
            const bt = data.backtest;
            combinedResults.push(bt);
            appendCombinedTradeRow(bt);
            // Funnel day row
            appendCombinedFunnelDayRow(data.trade_date, data.funnel);
            break;
        }

        case 'day_skip':
            appendCombinedTradeRow({
                trade_date: data.trade_date,
                has_trade: false,
                skip_reason: data.reason,
                capital: combinedResults.length > 0 ? combinedResults[combinedResults.length - 1].capital : 0,
            });
            appendCombinedFunnelDayRow(data.trade_date, null, data.reason);
            break;

        case 'complete': {
            document.getElementById('combined-loading').classList.add('hidden');
            // Backtest summary
            renderCombinedBacktestSummary(data.backtest_summary);
            // Funnel summary
            renderCombinedFunnelSummary(data.funnel_summary, data.conclusions);
            // Filtered-out best
            if (data.filtered_out_best) renderFilteredOutBest(data.filtered_out_best);
            // Loss analysis button
            const lossTrades = combinedResults.filter(d => d.has_trade && d.profit < 0);
            if (lossTrades.length > 0) {
                document.getElementById('combined-loss-count').textContent = lossTrades.length;
                document.getElementById('combined-loss-trigger').classList.remove('hidden');
            }
            break;
        }

        case 'error':
            document.getElementById('combined-loading').classList.add('hidden');
            alert(data.message);
            break;
    }
}

function appendCombinedTradeRow(d) {
    const tbody = document.getElementById('combined-trade-body');
    const tr = document.createElement('tr');

    if (!d.has_trade) {
        tr.className = 'range-skip-row';
        tr.innerHTML = `
            <td>${d.trade_date}</td>
            <td colspan="8" class="range-skip-reason">${d.skip_reason || '-'}${d.stock_code ? ' (' + d.stock_code + ')' : ''}</td>
            <td class="range-capital">${d.capital ? formatMoney(d.capital) : '-'}</td>
        `;
    } else {
        const profitClass = d.profit > 0 ? 'range-profit-pos' : (d.profit < 0 ? 'range-profit-neg' : '');
        tr.className = 'range-trade-row';
        tr.innerHTML = `
            <td>${d.trade_date}</td>
            <td><span class="stock-code">${d.stock_code}</span> ${d.stock_name}</td>
            <td>${d.board_name || '-'}</td>
            <td>${d.buy_price.toFixed(2)}</td>
            <td>${d.sell_date || '-'}</td>
            <td>${d.sell_price.toFixed(2)}</td>
            <td>${d.lots}</td>
            <td class="${profitClass}">${d.profit >= 0 ? '+' : ''}${d.profit.toFixed(2)}</td>
            <td class="${profitClass}">${d.return_pct >= 0 ? '+' : ''}${d.return_pct.toFixed(2)}%</td>
            <td class="range-capital">${formatMoney(d.capital)}</td>
        `;
    }

    tbody.appendChild(tr);
    tr.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function appendCombinedFunnelDayRow(tradeDate, layers, skipReason) {
    const tbody = document.getElementById('combined-funnel-day-body');
    const tr = document.createElement('tr');

    if (!layers) {
        tr.className = 'range-skip-row';
        tr.innerHTML = `<td>${tradeDate}</td><td colspan="5" class="range-skip-reason">${skipReason || '跳过'}</td>`;
    } else {
        let cells = `<td>${tradeDate}</td>`;
        for (const ln of LAYER_NAMES) {
            const l = layers[ln];
            if (l && l.count > 0) {
                const retClass = l.avg_return > 0 ? 'range-profit-pos' : (l.avg_return < 0 ? 'range-profit-neg' : '');
                cells += `<td><span class="funnel-cell-count">${l.count}</span> <span class="${retClass}">${l.avg_return >= 0 ? '+' : ''}${l.avg_return.toFixed(2)}%</span></td>`;
            } else {
                cells += `<td class="range-skip-reason">-</td>`;
            }
        }
        tr.innerHTML = cells;
    }
    tbody.appendChild(tr);
}

function renderCombinedBacktestSummary(s) {
    const returnClass = s.total_return_pct >= 0 ? 'range-profit-pos' : 'range-profit-neg';
    const html = `
        <div class="range-summary-grid">
            <div class="range-stat">
                <span class="range-stat-label">起始资金</span>
                <span class="range-stat-value">${formatMoney(s.initial_capital)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最终资金</span>
                <span class="range-stat-value ${returnClass}">${formatMoney(s.final_capital)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总收益率</span>
                <span class="range-stat-value ${returnClass}">${s.total_return_pct >= 0 ? '+' : ''}${s.total_return_pct.toFixed(2)}%</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">交易天数</span>
                <span class="range-stat-value">${s.trade_days} / ${s.total_days}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">胜率</span>
                <span class="range-stat-value">${s.win_rate.toFixed(1)}% (${s.win_days}胜 ${s.lose_days}负)</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最大单笔盈利</span>
                <span class="range-stat-value range-profit-pos">${s.max_win >= 0 ? '+' : ''}${s.max_win.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最大单笔亏损</span>
                <span class="range-stat-value range-profit-neg">${s.max_loss.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总手续费</span>
                <span class="range-stat-value">${s.total_commission.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总印花税</span>
                <span class="range-stat-value">${s.total_stamp_tax.toFixed(2)}</span>
            </div>
        </div>
    `;
    document.getElementById('combined-backtest-summary').innerHTML = html;
}

function renderCombinedFunnelSummary(summary, conclusions) {
    const tbody = document.getElementById('combined-funnel-summary-body');
    tbody.innerHTML = '';

    let prevReturn = null;
    for (const ln of LAYER_NAMES) {
        const s = summary[ln];
        if (!s) continue;

        const tr = document.createElement('tr');
        const retClass = s.avg_return > 0 ? 'range-profit-pos' : (s.avg_return < 0 ? 'range-profit-neg' : '');
        const medClass = s.median_return > 0 ? 'range-profit-pos' : (s.median_return < 0 ? 'range-profit-neg' : '');

        let effectHtml = '-';
        if (prevReturn !== null && s.avg_count > 0) {
            const diff = s.avg_return - prevReturn;
            if (diff > 0.05) {
                effectHtml = `<span class="funnel-effect-pos">+${diff.toFixed(2)}%</span>`;
            } else if (diff < -0.05) {
                effectHtml = `<span class="funnel-effect-neg">${diff.toFixed(2)}%</span>`;
            } else {
                effectHtml = `<span class="funnel-effect-neutral">${diff >= 0 ? '+' : ''}${diff.toFixed(2)}%</span>`;
            }
        }
        prevReturn = s.avg_count > 0 ? s.avg_return : prevReturn;

        tr.innerHTML = `
            <td class="funnel-layer-name">${ln}</td>
            <td>${s.avg_count.toFixed(1)}</td>
            <td class="${retClass}">${s.avg_return >= 0 ? '+' : ''}${s.avg_return.toFixed(2)}%</td>
            <td>${s.win_rate.toFixed(1)}%</td>
            <td class="${medClass}">${s.median_return >= 0 ? '+' : ''}${s.median_return.toFixed(2)}%</td>
            <td>${effectHtml}</td>
        `;
        tbody.appendChild(tr);
    }

    if (conclusions && conclusions.length > 0) {
        const el = document.getElementById('combined-conclusions');
        let html = '<div class="funnel-conclusion-box"><strong>结论:</strong><ul>';
        for (const c of conclusions) {
            let icon, cls;
            if (c.verdict === 'positive') { icon = '^'; cls = 'range-profit-pos'; }
            else if (c.verdict === 'negative') { icon = '!!'; cls = 'range-profit-neg'; }
            else { icon = '-'; cls = ''; }
            html += `<li class="${cls}">${c.filter}: 收益 ${c.prev_return >= 0 ? '+' : ''}${c.prev_return.toFixed(2)}% -> ${c.curr_return >= 0 ? '+' : ''}${c.curr_return.toFixed(2)}% (${c.diff >= 0 ? '+' : ''}${c.diff.toFixed(2)}%) ${icon === '!!' ? '疑似负面过滤!' : icon === '^' ? '有效过滤' : '影响不大'}</li>`;
        }
        html += '</ul></div>';
        el.innerHTML = html;
    }
}

function formatMoney(val) {
    return val.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// === Monitor Status Polling ===
async function refreshMonitorStatus() {
    try {
        const resp = await fetch('/api/momentum/monitor-status');
        const data = await resp.json();

        const statusEl = document.getElementById('monitor-status');
        statusEl.textContent = data.running ? '运行中' : '已停止';
        statusEl.className = 'status-indicator ' + (data.running ? 'running' : 'stopped');

        const lastEl = document.getElementById('monitor-last-result');
        if (data.last_scan_time) {
            const last = data.today_results[data.today_results.length - 1];
            if (last) {
                lastEl.innerHTML = `<p class="monitor-last">上次扫描: ${last.scan_time} | 选出 ${last.selected_count} 只</p>`;
            }
        } else {
            lastEl.innerHTML = '';
        }

        const historyEl = document.getElementById('history-container');
        if (data.today_results && data.today_results.length > 0) {
            let hhtml = '';
            data.today_results.forEach(r => {
                hhtml += `
                    <div class="history-item">
                        <span class="history-time">${r.scan_time}</span>
                        <span>初筛 ${r.initial_gainers} 只</span>
                        <span>热门板块 ${r.hot_boards} 个</span>
                        <span class="history-selected">选出 <strong>${r.selected_count}</strong> 只</span>
                    </div>
                `;
                if (r.selected_stocks && r.selected_stocks.length > 0) {
                    hhtml += '<div class="history-stocks">';
                    r.selected_stocks.forEach(s => {
                        hhtml += `<span class="history-stock">${s.stock_code} ${s.stock_name} +${s.open_gain_pct}%</span>`;
                    });
                    hhtml += '</div>';
                }
            });
            historyEl.innerHTML = hhtml;
        }
    } catch (e) {
        // Ignore poll errors
    }
}

refreshMonitorStatus();
setInterval(refreshMonitorStatus, 30000);

// === Loss Analysis (combined) ===
async function startCombinedLossAnalysis() {
    const lossTrades = combinedResults.filter(d => d.has_trade && d.profit < 0);
    if (lossTrades.length === 0) return;

    const btn = document.getElementById('combined-loss-btn');
    btn.disabled = true;
    btn.textContent = '分析中...';

    const section = document.getElementById('loss-analysis-section');
    section.classList.remove('hidden');
    document.getElementById('loss-analysis-progress').classList.remove('hidden');
    document.getElementById('loss-analysis-results').innerHTML = '';
    document.getElementById('loss-analysis-summary').classList.add('hidden');
    document.getElementById('loss-analysis-summary').innerHTML = '';

    section.scrollIntoView({ behavior: 'smooth', block: 'start' });

    const payload = lossTrades.map(t => ({
        trade_date: t.trade_date,
        stock_code: t.stock_code,
        stock_name: t.stock_name,
        board_name: t.board_name,
        buy_price: t.buy_price,
        sell_price: t.sell_price,
        sell_date: t.sell_date,
        profit: t.profit,
        return_pct: t.return_pct,
        lots: t.lots,
        hot_boards: t.hot_boards || {},
    }));

    try {
        const resp = await fetch('/api/momentum/loss-analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ losing_trades: payload }),
        });

        if (!resp.ok) {
            const errData = await resp.json();
            alert(errData.detail || '分析失败');
            return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const messages = buffer.split('\n\n');
            buffer = messages.pop();

            for (const msg of messages) {
                const trimmed = msg.trim();
                if (!trimmed.startsWith('data: ')) continue;
                try {
                    const data = JSON.parse(trimmed.substring(6));
                    handleLossAnalysisEvent(data);
                } catch (e) {}
            }
        }

        if (buffer.trim().startsWith('data: ')) {
            try {
                const data = JSON.parse(buffer.trim().substring(6));
                handleLossAnalysisEvent(data);
            } catch (e) {}
        }
    } catch (err) {
        alert('分析请求失败: ' + err.message);
    } finally {
        document.getElementById('loss-analysis-progress').classList.add('hidden');
        btn.disabled = false;
        btn.textContent = `亏损分析 (${lossTrades.length}笔)`;
    }
}

function handleLossAnalysisEvent(data) {
    switch (data.type) {
        case 'init':
            document.getElementById('loss-progress-text').textContent =
                `共 ${data.total} 笔亏损交易，开始分析...`;
            break;

        case 'progress':
            document.getElementById('loss-progress-text').textContent = data.message;
            break;

        case 'stock_analysis':
            appendStockAnalysisCard(data);
            break;

        case 'strategy_summary':
            renderStrategySummary(data.summary);
            break;

        case 'complete':
            document.getElementById('loss-analysis-progress').classList.add('hidden');
            break;

        case 'error':
            document.getElementById('loss-analysis-progress').classList.add('hidden');
            alert(data.message);
            break;
    }
}

function appendStockAnalysisCard(a) {
    const container = document.getElementById('loss-analysis-results');

    let boardHtml = '<span class="la-no-data">板块数据不可用</span>';
    const bd = a.board_data;
    if (bd && !bd.error) {
        boardHtml = `
            <div class="la-board-grid">
                ${bd.open_gain != null ? `<span class="la-board-item">开盘 <strong>${fmtGain(bd.open_gain)}</strong></span>` : ''}
                ${bd.gain_940 != null ? `<span class="la-board-item">9:40 <strong>${fmtGain(bd.gain_940)}</strong></span>` : ''}
                ${bd.day_gain != null ? `<span class="la-board-item">全天 <strong>${fmtGain(bd.day_gain)}</strong></span>` : ''}
                ${bd.max_gain != null ? `<span class="la-board-item">最高 <strong>${fmtGain(bd.max_gain)}</strong></span>` : ''}
                ${bd.min_gain != null ? `<span class="la-board-item">最低 <strong>${fmtGain(bd.min_gain)}</strong></span>` : ''}
            </div>
        `;
    } else if (bd && bd.error) {
        boardHtml = `<span class="la-no-data">${bd.error}</span>`;
    }

    let stockDayHtml = '';
    const sd = a.stock_day_data;
    if (sd && sd.prev_close) {
        stockDayHtml = `
            <div class="la-stock-day">
                <span>个股当日：</span>
                <span>开盘 <strong>${fmtGain(sd.open_gain)}</strong></span>
                <span>全天 <strong>${fmtGain(sd.day_gain)}</strong></span>
                <span>最高 <strong>${fmtGain(sd.max_gain)}</strong></span>
                <span>最低 <strong>${fmtGain(sd.min_gain)}</strong></span>
            </div>
        `;
    }

    const triggers = (a.trigger_codes || []).join(', ') || '无';

    const card = document.createElement('div');
    card.className = 'la-card';
    card.innerHTML = `
        <div class="la-card-header">
            <div class="la-stock-info">
                <span class="stock-code">${a.stock_code}</span>
                <span class="la-stock-name">${a.stock_name}</span>
                <span class="la-board-tag">${a.board_name}</span>
            </div>
            <div class="la-loss-info">
                <span class="la-loss-amount">${a.profit >= 0 ? '+' : ''}${a.profit.toFixed(2)}元</span>
                <span class="la-loss-pct">${a.return_pct >= 0 ? '+' : ''}${a.return_pct.toFixed(2)}%</span>
            </div>
        </div>
        <div class="la-card-meta">
            <span>买入 ${a.trade_date} @ ${a.buy_price}</span>
            <span>卖出 ${a.sell_date} @ ${a.sell_price}</span>
            <span>触发股: ${triggers}</span>
        </div>
        <div class="la-section">
            <div class="la-section-title">板块走势 (${a.board_name})</div>
            ${boardHtml}
        </div>
        ${stockDayHtml}
        <div class="la-section">
            <div class="la-section-title">AI 分析</div>
            <div class="la-llm-text">${a.llm_analysis || '分析中...'}</div>
        </div>
    `;
    container.appendChild(card);
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderStrategySummary(summary) {
    const el = document.getElementById('loss-analysis-summary');
    el.classList.remove('hidden');
    el.innerHTML = `
        <div class="la-summary">
            <div class="la-summary-title">策略总结</div>
            <div class="la-summary-text">${summary.replace(/\n/g, '<br>')}</div>
        </div>
    `;
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function fmtGain(val) {
    if (val == null) return '-';
    const cls = val > 0 ? 'range-profit-pos' : (val < 0 ? 'range-profit-neg' : '');
    return `<span class="${cls}">${val >= 0 ? '+' : ''}${val.toFixed(2)}%</span>`;
}

// === Filtered-out best stocks (shared renderer) ===
const _filteredPagerState = {};
let _filteredOutData = null;

function renderFilteredOutBest(filteredOutBest) {
    const el = document.getElementById('combined-filtered-out');
    if (!filteredOutBest || filteredOutBest.length === 0) return;

    _filteredOutData = filteredOutBest;
    for (let i = 0; i < filteredOutBest.length; i++) {
        _filteredPagerState[i] = 0;
    }

    let html = '<div class="funnel-filtered-box"><strong>被误杀的高收益股票</strong>';
    html += '<p class="form-hint">每层筛掉的票中，次日收益最好的 Top 3</p>';

    for (let i = 0; i < filteredOutBest.length; i++) {
        const layer = filteredOutBest[i];
        const avgCls = layer.avg_return > 0 ? 'range-profit-pos' : (layer.avg_return < 0 ? 'range-profit-neg' : '');

        html += `<div class="filtered-layer">`;
        html += `<span class="filtered-label">${layer.label}</span>`;
        html += `: 共筛掉 <strong>${layer.total_filtered}</strong> 只,`;
        html += ` 平均收益 <span class="${avgCls}">${layer.avg_return >= 0 ? '+' : ''}${layer.avg_return.toFixed(2)}%</span>,`;
        html += ` 其中 ${layer.positive_count} 只盈利`;

        html += `<div id="filtered-layer-${i}-content"></div>`;
        html += '</div>';
    }

    html += '</div>';
    el.innerHTML = html;

    for (let i = 0; i < filteredOutBest.length; i++) {
        _renderFilteredDay(i);
    }
}

function _renderFilteredDay(layerIdx) {
    const container = document.getElementById(`filtered-layer-${layerIdx}-content`);
    if (!container || !_filteredOutData) return;

    const layer = _filteredOutData[layerIdx];
    const days = layer.days || [];
    if (days.length === 0) {
        container.innerHTML = '';
        return;
    }

    const dayIdx = _filteredPagerState[layerIdx] || 0;
    const day = days[dayIdx];
    const total = days.length;

    let html = '<div class="filtered-pager">';
    html += `<button onclick="_filteredPagePrev(${layerIdx})" ${dayIdx === 0 ? 'disabled' : ''}>&laquo; 前一天</button>`;
    html += `<span class="pager-info">${day.trade_date} (${dayIdx + 1}/${total})</span>`;
    html += `<button onclick="_filteredPageNext(${layerIdx})" ${dayIdx >= total - 1 ? 'disabled' : ''}>后一天 &raquo;</button>`;
    html += '</div>';

    if (day.filtered_count === 0) {
        html += '<div class="filtered-day-stats">该日无筛除</div>';
    } else {
        const dAvgCls = day.avg_return > 0 ? 'range-profit-pos' : (day.avg_return < 0 ? 'range-profit-neg' : '');
        html += `<div class="filtered-day-stats">筛掉 ${day.filtered_count} 只,`;
        html += ` 平均收益 <span class="${dAvgCls}">${day.avg_return >= 0 ? '+' : ''}${day.avg_return.toFixed(2)}%</span>,`;
        html += ` 其中 ${day.positive_count} 只盈利</div>`;

        if (day.top_stocks && day.top_stocks.length > 0) {
            const showGrowth = layer.label.includes('最终推荐');
            html += '<table class="stock-table filtered-stock-table"><thead><tr>';
            html += '<th>代码</th><th>名称</th><th>板块</th>';
            if (showGrowth) html += '<th>营收增长率</th>';
            html += '<th>次日收益</th>';
            html += '</tr></thead><tbody>';
            for (const s of day.top_stocks) {
                const retCls = s.return_pct > 0 ? 'range-profit-pos' : (s.return_pct < 0 ? 'range-profit-neg' : '');
                html += `<tr>`;
                html += `<td>${s.stock_code}</td>`;
                html += `<td>${s.stock_name}</td>`;
                html += `<td>${s.board_name}</td>`;
                if (showGrowth) {
                    const rg = s.revenue_growth != null ? `${s.revenue_growth >= 0 ? '+' : ''}${s.revenue_growth.toFixed(1)}%` : '-';
                    html += `<td>${rg}</td>`;
                }
                html += `<td class="${retCls}">${s.return_pct >= 0 ? '+' : ''}${s.return_pct.toFixed(2)}%</td>`;
                html += `</tr>`;
            }
            html += '</tbody></table>';
        }
    }

    container.innerHTML = html;
}

function _filteredPagePrev(layerIdx) {
    if ((_filteredPagerState[layerIdx] || 0) > 0) {
        _filteredPagerState[layerIdx]--;
        _renderFilteredDay(layerIdx);
    }
}

function _filteredPageNext(layerIdx) {
    const days = _filteredOutData[layerIdx].days || [];
    if ((_filteredPagerState[layerIdx] || 0) < days.length - 1) {
        _filteredPagerState[layerIdx]++;
        _renderFilteredDay(layerIdx);
    }
}

// === Backfill ===
document.getElementById('backfill-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const startDate = document.getElementById('bf_start').value;
    const endDate = document.getElementById('bf_end').value;
    const errEl = document.getElementById('backfill-error');
    const btn = document.getElementById('backfill-btn');
    const progressEl = document.getElementById('backfill-progress');
    const statusEl = document.getElementById('bf-status');
    const barEl = document.getElementById('bf-bar');
    const logEl = document.getElementById('bf-log');
    errEl.style.display = 'none';

    if (!startDate || !endDate) {
        errEl.textContent = '请选择起始和结束日期';
        errEl.style.display = '';
        return;
    }

    btn.disabled = true;
    btn.textContent = '回填中...';
    progressEl.style.display = '';
    logEl.textContent = '';
    barEl.style.width = '0%';
    statusEl.textContent = '正在连接服务器...';

    try {
        const payload = {start_date: startDate, end_date: endDate};
        console.log('Backfill request payload:', payload);
        const resp = await fetch('/api/momentum/backfill', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
        });
        if (!resp.ok) {
            let msg = `请求失败 (${resp.status})`;
            try {
                const errData = await resp.json();
                const d = errData.detail;
                if (typeof d === 'string') msg = d;
                else if (Array.isArray(d)) msg = d.map(e => {
                    const loc = e.loc ? e.loc.join(' → ') : '';
                    return (loc ? loc + ': ' : '') + (e.msg || JSON.stringify(e));
                }).join('; ');
                else if (d) msg = JSON.stringify(d);
            } catch (_) {}
            throw new Error(msg);
        }
        statusEl.textContent = '已连接，等待数据...';
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const {done, value} = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, {stream: true});
            const lines = buffer.split('\n');
            buffer = lines.pop();

            for (const line of lines) {
                if (!line.startsWith('data: ')) continue;
                let data;
                try {
                    data = JSON.parse(line.slice(6));
                } catch (e) {
                    logEl.textContent += `[parse error] ${line}\n`;
                    continue;
                }

                if (data.type === 'status') {
                    statusEl.textContent = data.message;
                    logEl.textContent += data.message + '\n';
                } else if (data.type === 'init') {
                    statusEl.textContent = `待回填 ${data.total_days} 天（已跳过 ${data.skipped_days} 天）`;
                    logEl.textContent += `待回填 ${data.total_days} 天\n`;
                } else if (data.type === 'progress') {
                    const pct = Math.round(data.day / data.total * 100);
                    barEl.style.width = pct + '%';
                    statusEl.textContent = `[${data.day}/${data.total}] ${data.trade_date}`;
                } else if (data.type === 'day_result') {
                    const icon = data.status === 'ok' ? (data.stocks > 0 ? data.stocks + ' stocks' : '无选股') : data.status === 'skip' ? '跳过' : 'ERROR';
                    logEl.textContent += `${data.trade_date}: ${icon}${data.message ? ' — ' + data.message : ''}\n`;
                    logEl.scrollTop = logEl.scrollHeight;
                } else if (data.type === 'complete') {
                    barEl.style.width = '100%';
                    const msg = data.message || `完成: ${data.success} 天成功, ${data.errors} 天失败, 共 ${data.total_stocks} 条`;
                    statusEl.textContent = msg;
                    logEl.textContent += '\n' + msg + '\n';
                } else if (data.type === 'error') {
                    errEl.textContent = data.message;
                    errEl.style.display = '';
                    statusEl.textContent = '出错';
                }
                logEl.scrollTop = logEl.scrollHeight;
            }
        }
        if (statusEl.textContent === '已连接，等待数据...') {
            statusEl.textContent = '流已结束（未收到数据）';
        }
    } catch (err) {
        errEl.textContent = err.message;
        errEl.style.display = '';
        statusEl.textContent = '出错';
    } finally {
        btn.disabled = false;
        btn.textContent = '开始回填';
    }
});

// === CSV Export ===
document.getElementById('csv-export-btn').addEventListener('click', async () => {
    const startDate = document.getElementById('bf_start').value;
    const endDate = document.getElementById('bf_end').value;
    const errEl = document.getElementById('backfill-error');
    const btn = document.getElementById('csv-export-btn');
    errEl.style.display = 'none';

    if (!startDate || !endDate) {
        errEl.textContent = '请选择起始和结束日期';
        errEl.style.display = '';
        return;
    }

    btn.disabled = true;
    btn.textContent = '下载中...';
    try {
        const url = `/api/momentum/scan-stocks/csv?start_date=${startDate}&end_date=${endDate}`;
        const resp = await fetch(url);
        if (!resp.ok) {
            const data = await resp.json();
            const d = data.detail;
            const msg = typeof d === 'string' ? d : (Array.isArray(d) ? d.map(e => e.msg || JSON.stringify(e)).join('; ') : '下载失败');
            throw new Error(msg);
        }
        const blob = await resp.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `momentum_scan_stocks_${startDate}_${endDate}.csv`;
        a.click();
        URL.revokeObjectURL(a.href);
    } catch (err) {
        errEl.textContent = err.message;
        errEl.style.display = '';
    } finally {
        btn.disabled = false;
        btn.textContent = '下载 CSV';
    }
});
</script>
{% endblock %}
