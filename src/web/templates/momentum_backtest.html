{% extends "base.html" %}

{% block title %}动量板块策略{% endblock %}

{% block content %}
<div class="momentum-page">
    <h2>动量板块策略</h2>

    <!-- Monitor Status -->
    <section class="momentum-section">
        <div class="monitor-card">
            <div class="monitor-header">
                <h3>盘中监控</h3>
                <span id="monitor-status" class="status-indicator {{ 'running' if monitor_running else 'stopped' }}">
                    {{ '运行中' if monitor_running else '已停止' }}
                </span>
            </div>
            <p class="monitor-desc">每个交易日 9:30-9:40 自动追踪涨幅 >5% 主板非ST股票，选股后飞书通知</p>
            <div id="monitor-last-result"></div>
        </div>
    </section>

    <!-- Backtest Tabs -->
    <section class="momentum-section">
        <div class="sim-card">
            <div class="backtest-tabs">
                <button class="backtest-tab active" data-tab="single">单日回测</button>
                <button class="backtest-tab" data-tab="range">区间回测</button>
            </div>

            <!-- Single Day Backtest -->
            <div id="tab-single" class="tab-content">
                <form id="backtest-form" class="sim-form">
                    <div class="form-group">
                        <label for="trade_date">回测日期</label>
                        <input type="date" id="trade_date" name="trade_date" required>
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify" name="notify">
                            <span>同时发送飞书通知</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" id="backtest-btn">开始回测</button>
                </form>
            </div>

            <!-- Range Backtest -->
            <div id="tab-range" class="tab-content hidden">
                <form id="range-form" class="sim-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="range_start">起始日期</label>
                            <input type="date" id="range_start" name="range_start" required>
                        </div>
                        <div class="form-group">
                            <label for="range_end">结束日期</label>
                            <input type="date" id="range_end" name="range_end" required>
                        </div>
                        <div class="form-group">
                            <label for="initial_capital">起始资金 (元)</label>
                            <input type="number" id="initial_capital" name="initial_capital"
                                   value="100000" min="1000" step="1000" required>
                        </div>
                    </div>
                    <p class="form-hint">每天买入推荐股（开盘价），次日尾盘卖出（收盘价）。最多 90 个交易日。含手续费、过户费、印花税。</p>
                    <button type="submit" class="btn btn-primary" id="range-btn">开始区间回测</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Single Day Loading -->
    <section id="loading-section" class="momentum-section hidden">
        <div class="sim-card loading-card">
            <div class="loading-spinner"></div>
            <p>回测运行中，正在查询 iFinD 数据...</p>
            <p class="loading-hint">Step 1: iwencai 查询初筛 → Step 2: 反查概念板块 → Step 3: 热门板块 → Step 4: 成分股 → Step 5: PE过滤 → Step 6: 推股</p>
        </div>
    </section>

    <!-- Single Day Results -->
    <section id="results-section" class="momentum-section hidden">
        <div class="sim-card">
            <div class="result-header">
                <h3>回测结果 <span id="result-date"></span></h3>
                <div class="result-summary">
                    <span class="result-badge">初筛: <strong id="result-gainers">0</strong> 只</span>
                    <span class="result-badge">热门板块: <strong id="result-boards">0</strong> 个</span>
                    <span class="result-badge highlight">选股: <strong id="result-selected">0</strong> 只</span>
                    <span class="result-badge recommend" id="result-recommend-badge" style="display:none">
                        推股: <strong id="result-recommend-name"></strong>
                    </span>
                </div>
            </div>

            <!-- Recommendation card -->
            <div id="recommend-card" class="recommend-card hidden">
                <div class="recommend-label">推荐</div>
                <div class="recommend-body">
                    <div class="recommend-stock">
                        <span class="recommend-code" id="rec-code"></span>
                        <span class="recommend-stock-name" id="rec-name"></span>
                    </div>
                    <div class="recommend-details">
                        <span class="recommend-detail" id="rec-growth"></span>
                        <span class="recommend-detail" id="rec-gain"></span>
                        <span class="recommend-detail" id="rec-board"></span>
                    </div>
                </div>
            </div>

            <div id="result-empty" class="result-empty hidden">
                <p>未筛选到符合条件的股票</p>
            </div>

            <div id="result-boards-container"></div>
        </div>
    </section>

    <!-- Range Backtest Loading -->
    <section id="range-loading" class="momentum-section hidden">
        <div class="sim-card loading-card">
            <div class="loading-spinner"></div>
            <p id="range-progress-text">正在处理...</p>
            <div class="range-progress-bar">
                <div id="range-progress-fill" class="range-progress-fill"></div>
            </div>
            <p class="loading-hint" id="range-progress-hint"></p>
        </div>
    </section>

    <!-- Range Backtest Results -->
    <section id="range-results" class="momentum-section hidden">
        <div class="sim-card">
            <h3>区间回测结果</h3>

            <!-- Summary -->
            <div id="range-summary" class="range-summary"></div>

            <!-- Trade table -->
            <div class="range-table-wrap">
                <table class="stock-table range-table">
                    <thead>
                        <tr>
                            <th>买入日</th>
                            <th>推荐股</th>
                            <th>板块</th>
                            <th>买入价</th>
                            <th>卖出日</th>
                            <th>卖出价</th>
                            <th>手数</th>
                            <th>盈亏</th>
                            <th>收益率</th>
                            <th>当前资金</th>
                        </tr>
                    </thead>
                    <tbody id="range-table-body"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- History (today's monitor results) -->
    <section id="history-section" class="momentum-section">
        <div class="sim-card">
            <h3>今日监控记录</h3>
            <div id="history-container">
                <p class="empty-hint">暂无记录</p>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// === Tab Switching ===
document.querySelectorAll('.backtest-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.backtest-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById('tab-' + target).classList.remove('hidden');

        // Hide results from the other mode
        if (target === 'single') {
            document.getElementById('range-loading').classList.add('hidden');
            document.getElementById('range-results').classList.add('hidden');
        } else {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
        }
    });
});

// === Single Day Backtest ===
document.getElementById('backtest-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const tradeDate = document.getElementById('trade_date').value;
    const notify = document.getElementById('notify').checked;

    if (!tradeDate) return;

    document.getElementById('loading-section').classList.remove('hidden');
    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('backtest-btn').disabled = true;
    document.getElementById('backtest-btn').textContent = '运行中...';

    try {
        const resp = await fetch('/api/momentum/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trade_date: tradeDate, notify: notify }),
        });

        const data = await resp.json();

        if (!resp.ok) {
            alert(data.detail || '回测失败');
            return;
        }

        renderResults(data);
    } catch (err) {
        alert('请求失败: ' + err.message);
    } finally {
        document.getElementById('loading-section').classList.add('hidden');
        document.getElementById('backtest-btn').disabled = false;
        document.getElementById('backtest-btn').textContent = '开始回测';
    }
});

function renderResults(data) {
    document.getElementById('results-section').classList.remove('hidden');
    document.getElementById('result-date').textContent = data.trade_date;
    document.getElementById('result-gainers').textContent = data.initial_gainers;
    document.getElementById('result-boards').textContent = Object.keys(data.hot_boards || {}).length;
    document.getElementById('result-selected').textContent = (data.selected_stocks || []).length;

    const container = document.getElementById('result-boards-container');
    const emptyEl = document.getElementById('result-empty');
    const recBadge = document.getElementById('result-recommend-badge');
    const recCard = document.getElementById('recommend-card');

    const rec = data.recommended_stock;
    if (rec) {
        recBadge.style.display = '';
        document.getElementById('result-recommend-name').textContent = `${rec.stock_name}`;
        recCard.classList.remove('hidden');
        document.getElementById('rec-code').textContent = rec.stock_code;
        document.getElementById('rec-name').textContent = rec.stock_name;
        document.getElementById('rec-growth').textContent = `业绩增长: ${rec.growth_rate >= 0 ? '+' : ''}${rec.growth_rate.toFixed(1)}%`;
        document.getElementById('rec-gain').textContent = `开盘涨幅: +${rec.open_gain_pct.toFixed(2)}%`;
        document.getElementById('rec-board').textContent = `板块: ${rec.board_name} (选出${rec.board_stock_count}只最多)`;
    } else {
        recBadge.style.display = 'none';
        recCard.classList.add('hidden');
    }

    if (!data.selected_stocks || data.selected_stocks.length === 0) {
        container.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
    }

    emptyEl.classList.add('hidden');

    const boardMap = {};
    data.selected_stocks.forEach(s => {
        if (!boardMap[s.board_name]) boardMap[s.board_name] = [];
        boardMap[s.board_name].push(s);
    });

    let html = '';
    for (const [boardName, stocks] of Object.entries(boardMap)) {
        const triggerCodes = (data.hot_boards[boardName] || []).join(', ');
        html += `
            <div class="board-group">
                <div class="board-header">
                    <span class="board-name">${boardName}</span>
                    <span class="board-trigger">触发: ${triggerCodes}</span>
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>代码</th>
                            <th>名称</th>
                            <th>开盘涨幅</th>
                            <th>PE(TTM)</th>
                            <th>板块均值PE</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        stocks.forEach(s => {
            const gainClass = s.open_gain_pct > 3 ? 'gain-high' : (s.open_gain_pct > 1 ? 'gain-mid' : 'gain-low');
            const isRec = rec && s.stock_code === rec.stock_code;
            html += `
                        <tr class="${isRec ? 'recommended-row' : ''}">
                            <td class="stock-code">${s.stock_code}</td>
                            <td>${s.stock_name}${isRec ? ' <span class="rec-tag">推荐</span>' : ''}</td>
                            <td class="${gainClass}">+${s.open_gain_pct.toFixed(2)}%</td>
                            <td>${s.pe_ttm.toFixed(1)}</td>
                            <td>${s.board_avg_pe.toFixed(1)}</td>
                        </tr>
            `;
        });
        html += '</tbody></table></div>';
    }

    container.innerHTML = html;
}

// === Range Backtest ===
document.getElementById('range-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const startDate = document.getElementById('range_start').value;
    const endDate = document.getElementById('range_end').value;
    const initialCapital = parseFloat(document.getElementById('initial_capital').value);

    if (!startDate || !endDate) return;
    if (endDate <= startDate) { alert('结束日期必须晚于起始日期'); return; }
    if (initialCapital < 1000) { alert('起始资金不能低于 1000 元'); return; }

    // Reset UI
    document.getElementById('range-loading').classList.remove('hidden');
    document.getElementById('range-results').classList.add('hidden');
    document.getElementById('range-table-body').innerHTML = '';
    document.getElementById('range-summary').innerHTML = '';
    document.getElementById('range-btn').disabled = true;
    document.getElementById('range-btn').textContent = '运行中...';

    try {
        const resp = await fetch('/api/momentum/range-backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start_date: startDate,
                end_date: endDate,
                initial_capital: initialCapital,
            }),
        });

        if (!resp.ok) {
            const errData = await resp.json();
            alert(errData.detail || '回测失败');
            return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const messages = buffer.split('\n\n');
            buffer = messages.pop();

            for (const msg of messages) {
                const trimmed = msg.trim();
                if (!trimmed.startsWith('data: ')) continue;
                try {
                    const data = JSON.parse(trimmed.substring(6));
                    handleRangeEvent(data);
                } catch (parseErr) {
                    // skip malformed SSE
                }
            }
        }

        // Process any remaining buffer
        if (buffer.trim().startsWith('data: ')) {
            try {
                const data = JSON.parse(buffer.trim().substring(6));
                handleRangeEvent(data);
            } catch (e) {}
        }

    } catch (err) {
        alert('请求失败: ' + err.message);
    } finally {
        document.getElementById('range-loading').classList.add('hidden');
        document.getElementById('range-btn').disabled = false;
        document.getElementById('range-btn').textContent = '开始区间回测';
    }
});

function handleRangeEvent(data) {
    switch (data.type) {
        case 'init':
            document.getElementById('range-progress-hint').textContent =
                `${data.start_date} ~ ${data.end_date}，共 ${data.total_days} 个交易日`;
            break;

        case 'warning':
            document.getElementById('range-progress-hint').textContent = data.message;
            break;

        case 'progress':
            document.getElementById('range-progress-text').textContent =
                `正在处理第 ${data.day} / ${data.total} 天 (${data.trade_date})...`;
            const pct = (data.day / data.total * 100).toFixed(0);
            document.getElementById('range-progress-fill').style.width = pct + '%';
            break;

        case 'day_result':
            // Show results section
            document.getElementById('range-results').classList.remove('hidden');
            appendRangeDayRow(data);
            break;

        case 'complete':
            document.getElementById('range-loading').classList.add('hidden');
            renderRangeSummary(data.summary);
            break;

        case 'error':
            document.getElementById('range-loading').classList.add('hidden');
            alert(data.message);
            break;
    }
}

function appendRangeDayRow(d) {
    const tbody = document.getElementById('range-table-body');
    const tr = document.createElement('tr');

    if (!d.has_trade) {
        tr.className = 'range-skip-row';
        tr.innerHTML = `
            <td>${d.trade_date}</td>
            <td colspan="8" class="range-skip-reason">${d.skip_reason}${d.stock_code ? ' (' + d.stock_code + ')' : ''}</td>
            <td class="range-capital">${formatMoney(d.capital)}</td>
        `;
    } else {
        const profitClass = d.profit > 0 ? 'range-profit-pos' : (d.profit < 0 ? 'range-profit-neg' : '');
        tr.className = profitClass ? 'range-trade-row' : 'range-trade-row';
        tr.innerHTML = `
            <td>${d.trade_date}</td>
            <td><span class="stock-code">${d.stock_code}</span> ${d.stock_name}</td>
            <td>${d.board_name || '-'}</td>
            <td>${d.buy_price.toFixed(2)}</td>
            <td>${d.sell_date || '-'}</td>
            <td>${d.sell_price.toFixed(2)}</td>
            <td>${d.lots}</td>
            <td class="${profitClass}">${d.profit >= 0 ? '+' : ''}${d.profit.toFixed(2)}</td>
            <td class="${profitClass}">${d.return_pct >= 0 ? '+' : ''}${d.return_pct.toFixed(2)}%</td>
            <td class="range-capital">${formatMoney(d.capital)}</td>
        `;
    }

    tbody.appendChild(tr);
    // Auto-scroll to bottom
    tr.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderRangeSummary(s) {
    const returnClass = s.total_return_pct >= 0 ? 'range-profit-pos' : 'range-profit-neg';
    const html = `
        <div class="range-summary-grid">
            <div class="range-stat">
                <span class="range-stat-label">起始资金</span>
                <span class="range-stat-value">${formatMoney(s.initial_capital)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最终资金</span>
                <span class="range-stat-value ${returnClass}">${formatMoney(s.final_capital)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总收益率</span>
                <span class="range-stat-value ${returnClass}">${s.total_return_pct >= 0 ? '+' : ''}${s.total_return_pct.toFixed(2)}%</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">交易天数</span>
                <span class="range-stat-value">${s.trade_days} / ${s.total_days}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">胜率</span>
                <span class="range-stat-value">${s.win_rate.toFixed(1)}% (${s.win_days}胜 ${s.lose_days}负)</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最大单笔盈利</span>
                <span class="range-stat-value range-profit-pos">${s.max_win >= 0 ? '+' : ''}${s.max_win.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最大单笔亏损</span>
                <span class="range-stat-value range-profit-neg">${s.max_loss.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总手续费</span>
                <span class="range-stat-value">${s.total_commission.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总印花税</span>
                <span class="range-stat-value">${s.total_stamp_tax.toFixed(2)}</span>
            </div>
        </div>
    `;
    document.getElementById('range-summary').innerHTML = html;
}

function formatMoney(val) {
    return val.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// === Monitor Status Polling ===
async function refreshMonitorStatus() {
    try {
        const resp = await fetch('/api/momentum/monitor-status');
        const data = await resp.json();

        const statusEl = document.getElementById('monitor-status');
        statusEl.textContent = data.running ? '运行中' : '已停止';
        statusEl.className = 'status-indicator ' + (data.running ? 'running' : 'stopped');

        const lastEl = document.getElementById('monitor-last-result');
        if (data.last_scan_time) {
            const last = data.today_results[data.today_results.length - 1];
            if (last) {
                lastEl.innerHTML = `<p class="monitor-last">上次扫描: ${last.scan_time} | 选出 ${last.selected_count} 只</p>`;
            }
        } else {
            lastEl.innerHTML = '';
        }

        const historyEl = document.getElementById('history-container');
        if (data.today_results && data.today_results.length > 0) {
            let hhtml = '';
            data.today_results.forEach(r => {
                hhtml += `
                    <div class="history-item">
                        <span class="history-time">${r.scan_time}</span>
                        <span>初筛 ${r.initial_gainers} 只</span>
                        <span>热门板块 ${r.hot_boards} 个</span>
                        <span class="history-selected">选出 <strong>${r.selected_count}</strong> 只</span>
                    </div>
                `;
                if (r.selected_stocks && r.selected_stocks.length > 0) {
                    hhtml += '<div class="history-stocks">';
                    r.selected_stocks.forEach(s => {
                        hhtml += `<span class="history-stock">${s.stock_code} ${s.stock_name} +${s.open_gain_pct}%</span>`;
                    });
                    hhtml += '</div>';
                }
            });
            historyEl.innerHTML = hhtml;
        }
    } catch (e) {
        // Ignore poll errors
    }
}

refreshMonitorStatus();
setInterval(refreshMonitorStatus, 30000);
</script>
{% endblock %}
