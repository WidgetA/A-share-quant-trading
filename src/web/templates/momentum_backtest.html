{% extends "base.html" %}

{% block title %}动量板块策略{% endblock %}

{% block content %}
<div class="momentum-page">
    <h2>动量板块策略</h2>

    <!-- Monitor Status -->
    <section class="momentum-section">
        <div class="monitor-card">
            <div class="monitor-header">
                <h3>盘中监控</h3>
                <span id="monitor-status" class="status-indicator {{ 'running' if monitor_running else 'stopped' }}">
                    {{ '运行中' if monitor_running else '已停止' }}
                </span>
            </div>
            <p class="monitor-desc">每个交易日 9:30-9:40 自动追踪涨幅 >5% 主板非ST股票，选股后飞书通知</p>
            <div id="monitor-last-result"></div>
        </div>
    </section>

    <!-- Backtest Tabs -->
    <section class="momentum-section">
        <div class="sim-card">
            <div class="backtest-tabs">
                <button class="backtest-tab active" data-tab="single">单日回测</button>
                <button class="backtest-tab" data-tab="range">区间回测</button>
                <button class="backtest-tab" data-tab="funnel">漏斗分析</button>
            </div>

            <!-- Single Day Backtest -->
            <div id="tab-single" class="tab-content">
                <form id="backtest-form" class="sim-form">
                    <div class="form-group">
                        <label for="trade_date">回测日期</label>
                        <input type="date" id="trade_date" name="trade_date" required>
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify" name="notify">
                            <span>同时发送飞书通知</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" id="backtest-btn">开始回测</button>
                </form>
            </div>

            <!-- Range Backtest -->
            <div id="tab-range" class="tab-content hidden">
                <form id="range-form" class="sim-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="range_start">起始日期</label>
                            <input type="date" id="range_start" name="range_start" required>
                        </div>
                        <div class="form-group">
                            <label for="range_end">结束日期</label>
                            <input type="date" id="range_end" name="range_end" required>
                        </div>
                        <div class="form-group">
                            <label for="initial_capital">起始资金 (元)</label>
                            <input type="number" id="initial_capital" name="initial_capital"
                                   value="100000" min="1000" step="1000" required>
                        </div>
                    </div>
                    <p class="form-hint">每天买入推荐股（9:40价），次日开盘卖出（开盘价）。最多 90 个交易日。含手续费、过户费、印花税。</p>
                    <button type="submit" class="btn btn-primary" id="range-btn">开始区间回测</button>
                </form>
            </div>

            <!-- Funnel Analysis -->
            <div id="tab-funnel" class="tab-content hidden">
                <form id="funnel-form" class="sim-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="funnel_start">起始日期</label>
                            <input type="date" id="funnel_start" name="funnel_start" required>
                        </div>
                        <div class="form-group">
                            <label for="funnel_end">结束日期</label>
                            <input type="date" id="funnel_end" name="funnel_end" required>
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="funnel_fade" name="funnel_fade" checked>
                            <span>启用高开低走过滤 (L3)</span>
                        </label>
                    </div>
                    <p class="form-hint">逐层分析选股漏斗效果：全部成分股 → 涨幅筛选 → PE过滤 → 高开低走过滤 → 最终推荐。每层假设9:40买入，次日收盘卖出，对比收益。</p>
                    <button type="submit" class="btn btn-primary" id="funnel-btn">开始分析</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Single Day Loading -->
    <section id="loading-section" class="momentum-section hidden">
        <div class="sim-card loading-card">
            <div class="loading-spinner"></div>
            <p>回测运行中，正在查询 iFinD 数据...</p>
            <p class="loading-hint">Step 1: iwencai 查询初筛 → Step 2: 反查概念板块 → Step 3: 热门板块 → Step 4: 成分股 → Step 5: PE过滤 → Step 6: 推股</p>
        </div>
    </section>

    <!-- Single Day Results -->
    <section id="results-section" class="momentum-section hidden">
        <div class="sim-card">
            <div class="result-header">
                <h3>回测结果 <span id="result-date"></span></h3>
                <div class="result-summary">
                    <span class="result-badge">初筛: <strong id="result-gainers">0</strong> 只</span>
                    <span class="result-badge">热门板块: <strong id="result-boards">0</strong> 个</span>
                    <span class="result-badge highlight">选股: <strong id="result-selected">0</strong> 只</span>
                    <span class="result-badge recommend" id="result-recommend-badge" style="display:none">
                        推股: <strong id="result-recommend-name"></strong>
                    </span>
                </div>
            </div>

            <!-- Recommendation card -->
            <div id="recommend-card" class="recommend-card hidden">
                <div class="recommend-label">推荐</div>
                <div class="recommend-body">
                    <div class="recommend-stock">
                        <span class="recommend-code" id="rec-code"></span>
                        <span class="recommend-stock-name" id="rec-name"></span>
                    </div>
                    <div class="recommend-details">
                        <span class="recommend-detail" id="rec-growth"></span>
                        <span class="recommend-detail" id="rec-gain"></span>
                        <span class="recommend-detail" id="rec-board"></span>
                    </div>
                </div>
            </div>

            <div id="result-empty" class="result-empty hidden">
                <p>未筛选到符合条件的股票</p>
            </div>

            <div id="result-boards-container"></div>
        </div>
    </section>

    <!-- Range Backtest Loading -->
    <section id="range-loading" class="momentum-section hidden">
        <div class="sim-card loading-card">
            <div class="loading-spinner"></div>
            <p id="range-progress-text">正在处理...</p>
            <div class="range-progress-bar">
                <div id="range-progress-fill" class="range-progress-fill"></div>
            </div>
            <p class="loading-hint" id="range-progress-hint"></p>
        </div>
    </section>

    <!-- Range Backtest Results -->
    <section id="range-results" class="momentum-section hidden">
        <div class="sim-card">
            <h3>区间回测结果</h3>

            <!-- Summary -->
            <div id="range-summary" class="range-summary"></div>

            <!-- Trade table -->
            <div class="range-table-wrap">
                <table class="stock-table range-table">
                    <thead>
                        <tr>
                            <th>买入日</th>
                            <th>推荐股</th>
                            <th>板块</th>
                            <th>买入价</th>
                            <th>卖出日</th>
                            <th>卖出价</th>
                            <th>手数</th>
                            <th>盈亏</th>
                            <th>收益率</th>
                            <th>当前资金</th>
                        </tr>
                    </thead>
                    <tbody id="range-table-body"></tbody>
                </table>
            </div>

            <!-- Loss Analysis Button -->
            <div id="loss-analysis-trigger" class="loss-analysis-trigger hidden">
                <button id="loss-analysis-btn" class="btn btn-loss-analysis" onclick="startLossAnalysis()">
                    亏损分析 (<span id="loss-count">0</span>笔)
                </button>
            </div>
        </div>
    </section>

    <!-- Loss Analysis Results -->
    <section id="loss-analysis-section" class="momentum-section hidden">
        <div class="sim-card">
            <h3>亏损分析</h3>

            <!-- Progress -->
            <div id="loss-analysis-progress" class="loss-progress hidden">
                <div class="loading-spinner-sm"></div>
                <span id="loss-progress-text">正在分析...</span>
            </div>

            <!-- Per-stock analysis cards -->
            <div id="loss-analysis-results"></div>

            <!-- Strategy summary -->
            <div id="loss-analysis-summary" class="hidden"></div>
        </div>
    </section>

    <!-- Funnel Analysis Loading -->
    <section id="funnel-loading" class="momentum-section hidden">
        <div class="sim-card loading-card">
            <div class="loading-spinner"></div>
            <p id="funnel-progress-text">正在分析...</p>
            <div class="range-progress-bar">
                <div id="funnel-progress-fill" class="range-progress-fill"></div>
            </div>
            <p class="loading-hint" id="funnel-progress-hint"></p>
        </div>
    </section>

    <!-- Funnel Analysis Results -->
    <section id="funnel-results" class="momentum-section hidden">
        <div class="sim-card">
            <h3>漏斗层级收益分析</h3>

            <!-- Summary table -->
            <div class="range-table-wrap">
                <table class="stock-table funnel-table">
                    <thead>
                        <tr>
                            <th>层级</th>
                            <th>平均股数</th>
                            <th>平均次日收益</th>
                            <th>胜率</th>
                            <th>中位收益</th>
                            <th>层级效果</th>
                        </tr>
                    </thead>
                    <tbody id="funnel-summary-body"></tbody>
                </table>
            </div>

            <!-- Conclusions -->
            <div id="funnel-conclusions" class="funnel-conclusions"></div>

            <!-- Per-day detail (collapsible) -->
            <details class="funnel-details">
                <summary>逐日明细</summary>
                <div class="range-table-wrap">
                    <table class="stock-table funnel-day-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>L0 成分股</th>
                                <th>L1 涨幅</th>
                                <th>L2 PE</th>
                                <th>L3 高开低走</th>
                                <th>L4 推荐</th>
                            </tr>
                        </thead>
                        <tbody id="funnel-day-body"></tbody>
                    </table>
                </div>
            </details>
        </div>
    </section>

    <!-- History (today's monitor results) -->
    <section id="history-section" class="momentum-section">
        <div class="sim-card">
            <h3>今日监控记录</h3>
            <div id="history-container">
                <p class="empty-hint">暂无记录</p>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// === Range Results Store (for loss analysis) ===
let rangeResults = [];

// === Tab Switching ===
const allResultSections = [
    'loading-section', 'results-section',
    'range-loading', 'range-results', 'loss-analysis-section',
    'funnel-loading', 'funnel-results',
];
document.querySelectorAll('.backtest-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.backtest-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById('tab-' + target).classList.remove('hidden');

        // Hide all result sections except for the active tab's own
        const keep = target === 'single' ? ['loading-section', 'results-section']
                   : target === 'range' ? ['range-loading', 'range-results', 'loss-analysis-section']
                   : ['funnel-loading', 'funnel-results'];
        allResultSections.forEach(id => {
            if (!keep.includes(id)) document.getElementById(id).classList.add('hidden');
        });
    });
});

// === Single Day Backtest ===
document.getElementById('backtest-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const tradeDate = document.getElementById('trade_date').value;
    const notify = document.getElementById('notify').checked;

    if (!tradeDate) return;

    document.getElementById('loading-section').classList.remove('hidden');
    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('backtest-btn').disabled = true;
    document.getElementById('backtest-btn').textContent = '运行中...';

    try {
        const resp = await fetch('/api/momentum/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trade_date: tradeDate, notify: notify }),
        });

        const data = await resp.json();

        if (!resp.ok) {
            alert(data.detail || '回测失败');
            return;
        }

        renderResults(data);
    } catch (err) {
        alert('请求失败: ' + err.message);
    } finally {
        document.getElementById('loading-section').classList.add('hidden');
        document.getElementById('backtest-btn').disabled = false;
        document.getElementById('backtest-btn').textContent = '开始回测';
    }
});

function renderResults(data) {
    document.getElementById('results-section').classList.remove('hidden');
    document.getElementById('result-date').textContent = data.trade_date;
    document.getElementById('result-gainers').textContent = data.initial_gainers;
    document.getElementById('result-boards').textContent = Object.keys(data.hot_boards || {}).length;
    document.getElementById('result-selected').textContent = (data.selected_stocks || []).length;

    const container = document.getElementById('result-boards-container');
    const emptyEl = document.getElementById('result-empty');
    const recBadge = document.getElementById('result-recommend-badge');
    const recCard = document.getElementById('recommend-card');

    const rec = data.recommended_stock;
    if (rec) {
        recBadge.style.display = '';
        document.getElementById('result-recommend-name').textContent = `${rec.stock_name}`;
        recCard.classList.remove('hidden');
        document.getElementById('rec-code').textContent = rec.stock_code;
        document.getElementById('rec-name').textContent = rec.stock_name;
        document.getElementById('rec-growth').textContent = `业绩增长: ${rec.growth_rate >= 0 ? '+' : ''}${rec.growth_rate.toFixed(1)}%`;
        document.getElementById('rec-gain').textContent = `开盘涨幅: +${rec.open_gain_pct.toFixed(2)}%`;
        document.getElementById('rec-board').textContent = `板块: ${rec.board_name} (选出${rec.board_stock_count}只最多)`;
    } else {
        recBadge.style.display = 'none';
        recCard.classList.add('hidden');
    }

    if (!data.selected_stocks || data.selected_stocks.length === 0) {
        container.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
    }

    emptyEl.classList.add('hidden');

    const boardMap = {};
    data.selected_stocks.forEach(s => {
        if (!boardMap[s.board_name]) boardMap[s.board_name] = [];
        boardMap[s.board_name].push(s);
    });

    let html = '';
    for (const [boardName, stocks] of Object.entries(boardMap)) {
        const triggerCodes = (data.hot_boards[boardName] || []).join(', ');
        html += `
            <div class="board-group">
                <div class="board-header">
                    <span class="board-name">${boardName}</span>
                    <span class="board-trigger">触发: ${triggerCodes}</span>
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>代码</th>
                            <th>名称</th>
                            <th>开盘涨幅</th>
                            <th>PE(TTM)</th>
                            <th>板块均值PE</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        stocks.forEach(s => {
            const gainClass = s.open_gain_pct > 3 ? 'gain-high' : (s.open_gain_pct > 1 ? 'gain-mid' : 'gain-low');
            const isRec = rec && s.stock_code === rec.stock_code;
            html += `
                        <tr class="${isRec ? 'recommended-row' : ''}">
                            <td class="stock-code">${s.stock_code}</td>
                            <td>${s.stock_name}${isRec ? ' <span class="rec-tag">推荐</span>' : ''}</td>
                            <td class="${gainClass}">+${s.open_gain_pct.toFixed(2)}%</td>
                            <td>${s.pe_ttm.toFixed(1)}</td>
                            <td>${s.board_avg_pe.toFixed(1)}</td>
                        </tr>
            `;
        });
        html += '</tbody></table></div>';
    }

    container.innerHTML = html;
}

// === Range Backtest ===
document.getElementById('range-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const startDate = document.getElementById('range_start').value;
    const endDate = document.getElementById('range_end').value;
    const initialCapital = parseFloat(document.getElementById('initial_capital').value);

    if (!startDate || !endDate) return;
    if (endDate <= startDate) { alert('结束日期必须晚于起始日期'); return; }
    if (initialCapital < 1000) { alert('起始资金不能低于 1000 元'); return; }

    // Reset UI
    rangeResults = [];
    document.getElementById('range-loading').classList.remove('hidden');
    document.getElementById('range-results').classList.add('hidden');
    document.getElementById('range-table-body').innerHTML = '';
    document.getElementById('range-summary').innerHTML = '';
    document.getElementById('loss-analysis-trigger').classList.add('hidden');
    document.getElementById('loss-analysis-section').classList.add('hidden');
    document.getElementById('range-btn').disabled = true;
    document.getElementById('range-btn').textContent = '运行中...';

    try {
        const resp = await fetch('/api/momentum/range-backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start_date: startDate,
                end_date: endDate,
                initial_capital: initialCapital,
            }),
        });

        if (!resp.ok) {
            const errData = await resp.json();
            alert(errData.detail || '回测失败');
            return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const messages = buffer.split('\n\n');
            buffer = messages.pop();

            for (const msg of messages) {
                const trimmed = msg.trim();
                if (!trimmed.startsWith('data: ')) continue;
                try {
                    const data = JSON.parse(trimmed.substring(6));
                    handleRangeEvent(data);
                } catch (parseErr) {
                    // skip malformed SSE
                }
            }
        }

        // Process any remaining buffer
        if (buffer.trim().startsWith('data: ')) {
            try {
                const data = JSON.parse(buffer.trim().substring(6));
                handleRangeEvent(data);
            } catch (e) {}
        }

    } catch (err) {
        alert('请求失败: ' + err.message);
    } finally {
        document.getElementById('range-loading').classList.add('hidden');
        document.getElementById('range-btn').disabled = false;
        document.getElementById('range-btn').textContent = '开始区间回测';
    }
});

function handleRangeEvent(data) {
    switch (data.type) {
        case 'init':
            document.getElementById('range-progress-hint').textContent =
                `${data.start_date} ~ ${data.end_date}，共 ${data.total_days} 个交易日`;
            break;

        case 'warning':
            document.getElementById('range-progress-hint').textContent = data.message;
            break;

        case 'progress': {
            document.getElementById('range-progress-text').textContent =
                `正在处理第 ${data.day} / ${data.total} 天 (${data.trade_date})...`;
            const pct = (data.day / data.total * 100).toFixed(0);
            document.getElementById('range-progress-fill').style.width = pct + '%';
            break;
        }

        case 'day_result':
            // Store result and show results section
            rangeResults.push(data);
            document.getElementById('range-results').classList.remove('hidden');
            appendRangeDayRow(data);
            break;

        case 'complete': {
            document.getElementById('range-loading').classList.add('hidden');
            renderRangeSummary(data.summary);
            // Show loss analysis button if there are losing trades
            const lossTrades = rangeResults.filter(d => d.has_trade && d.profit < 0);
            if (lossTrades.length > 0) {
                document.getElementById('loss-count').textContent = lossTrades.length;
                document.getElementById('loss-analysis-trigger').classList.remove('hidden');
            }
            break;
        }

        case 'error':
            document.getElementById('range-loading').classList.add('hidden');
            alert(data.message);
            break;
    }
}

function appendRangeDayRow(d) {
    const tbody = document.getElementById('range-table-body');
    const tr = document.createElement('tr');

    if (!d.has_trade) {
        tr.className = 'range-skip-row';
        tr.innerHTML = `
            <td>${d.trade_date}</td>
            <td colspan="8" class="range-skip-reason">${d.skip_reason}${d.stock_code ? ' (' + d.stock_code + ')' : ''}</td>
            <td class="range-capital">${formatMoney(d.capital)}</td>
        `;
    } else {
        const profitClass = d.profit > 0 ? 'range-profit-pos' : (d.profit < 0 ? 'range-profit-neg' : '');
        tr.className = profitClass ? 'range-trade-row' : 'range-trade-row';
        tr.innerHTML = `
            <td>${d.trade_date}</td>
            <td><span class="stock-code">${d.stock_code}</span> ${d.stock_name}</td>
            <td>${d.board_name || '-'}</td>
            <td>${d.buy_price.toFixed(2)}</td>
            <td>${d.sell_date || '-'}</td>
            <td>${d.sell_price.toFixed(2)}</td>
            <td>${d.lots}</td>
            <td class="${profitClass}">${d.profit >= 0 ? '+' : ''}${d.profit.toFixed(2)}</td>
            <td class="${profitClass}">${d.return_pct >= 0 ? '+' : ''}${d.return_pct.toFixed(2)}%</td>
            <td class="range-capital">${formatMoney(d.capital)}</td>
        `;
    }

    tbody.appendChild(tr);
    // Auto-scroll to bottom
    tr.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderRangeSummary(s) {
    const returnClass = s.total_return_pct >= 0 ? 'range-profit-pos' : 'range-profit-neg';
    const html = `
        <div class="range-summary-grid">
            <div class="range-stat">
                <span class="range-stat-label">起始资金</span>
                <span class="range-stat-value">${formatMoney(s.initial_capital)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最终资金</span>
                <span class="range-stat-value ${returnClass}">${formatMoney(s.final_capital)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总收益率</span>
                <span class="range-stat-value ${returnClass}">${s.total_return_pct >= 0 ? '+' : ''}${s.total_return_pct.toFixed(2)}%</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">交易天数</span>
                <span class="range-stat-value">${s.trade_days} / ${s.total_days}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">胜率</span>
                <span class="range-stat-value">${s.win_rate.toFixed(1)}% (${s.win_days}胜 ${s.lose_days}负)</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最大单笔盈利</span>
                <span class="range-stat-value range-profit-pos">${s.max_win >= 0 ? '+' : ''}${s.max_win.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">最大单笔亏损</span>
                <span class="range-stat-value range-profit-neg">${s.max_loss.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总手续费</span>
                <span class="range-stat-value">${s.total_commission.toFixed(2)}</span>
            </div>
            <div class="range-stat">
                <span class="range-stat-label">总印花税</span>
                <span class="range-stat-value">${s.total_stamp_tax.toFixed(2)}</span>
            </div>
        </div>
    `;
    document.getElementById('range-summary').innerHTML = html;
}

function formatMoney(val) {
    return val.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// === Monitor Status Polling ===
async function refreshMonitorStatus() {
    try {
        const resp = await fetch('/api/momentum/monitor-status');
        const data = await resp.json();

        const statusEl = document.getElementById('monitor-status');
        statusEl.textContent = data.running ? '运行中' : '已停止';
        statusEl.className = 'status-indicator ' + (data.running ? 'running' : 'stopped');

        const lastEl = document.getElementById('monitor-last-result');
        if (data.last_scan_time) {
            const last = data.today_results[data.today_results.length - 1];
            if (last) {
                lastEl.innerHTML = `<p class="monitor-last">上次扫描: ${last.scan_time} | 选出 ${last.selected_count} 只</p>`;
            }
        } else {
            lastEl.innerHTML = '';
        }

        const historyEl = document.getElementById('history-container');
        if (data.today_results && data.today_results.length > 0) {
            let hhtml = '';
            data.today_results.forEach(r => {
                hhtml += `
                    <div class="history-item">
                        <span class="history-time">${r.scan_time}</span>
                        <span>初筛 ${r.initial_gainers} 只</span>
                        <span>热门板块 ${r.hot_boards} 个</span>
                        <span class="history-selected">选出 <strong>${r.selected_count}</strong> 只</span>
                    </div>
                `;
                if (r.selected_stocks && r.selected_stocks.length > 0) {
                    hhtml += '<div class="history-stocks">';
                    r.selected_stocks.forEach(s => {
                        hhtml += `<span class="history-stock">${s.stock_code} ${s.stock_name} +${s.open_gain_pct}%</span>`;
                    });
                    hhtml += '</div>';
                }
            });
            historyEl.innerHTML = hhtml;
        }
    } catch (e) {
        // Ignore poll errors
    }
}

refreshMonitorStatus();
setInterval(refreshMonitorStatus, 30000);

// === Loss Analysis ===
async function startLossAnalysis() {
    const lossTrades = rangeResults.filter(d => d.has_trade && d.profit < 0);
    if (lossTrades.length === 0) return;

    // Disable button
    const btn = document.getElementById('loss-analysis-btn');
    btn.disabled = true;
    btn.textContent = '分析中...';

    // Show section and progress
    const section = document.getElementById('loss-analysis-section');
    section.classList.remove('hidden');
    document.getElementById('loss-analysis-progress').classList.remove('hidden');
    document.getElementById('loss-analysis-results').innerHTML = '';
    document.getElementById('loss-analysis-summary').classList.add('hidden');
    document.getElementById('loss-analysis-summary').innerHTML = '';

    // Scroll to section
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Prepare payload
    const payload = lossTrades.map(t => ({
        trade_date: t.trade_date,
        stock_code: t.stock_code,
        stock_name: t.stock_name,
        board_name: t.board_name,
        buy_price: t.buy_price,
        sell_price: t.sell_price,
        sell_date: t.sell_date,
        profit: t.profit,
        return_pct: t.return_pct,
        lots: t.lots,
        hot_boards: t.hot_boards || {},
    }));

    try {
        const resp = await fetch('/api/momentum/loss-analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ losing_trades: payload }),
        });

        if (!resp.ok) {
            const errData = await resp.json();
            alert(errData.detail || '分析失败');
            return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const messages = buffer.split('\n\n');
            buffer = messages.pop();

            for (const msg of messages) {
                const trimmed = msg.trim();
                if (!trimmed.startsWith('data: ')) continue;
                try {
                    const data = JSON.parse(trimmed.substring(6));
                    handleLossAnalysisEvent(data);
                } catch (e) {}
            }
        }

        // Process remaining buffer
        if (buffer.trim().startsWith('data: ')) {
            try {
                const data = JSON.parse(buffer.trim().substring(6));
                handleLossAnalysisEvent(data);
            } catch (e) {}
        }
    } catch (err) {
        alert('分析请求失败: ' + err.message);
    } finally {
        document.getElementById('loss-analysis-progress').classList.add('hidden');
        btn.disabled = false;
        btn.textContent = `亏损分析 (${lossTrades.length}笔)`;
    }
}

function handleLossAnalysisEvent(data) {
    switch (data.type) {
        case 'init':
            document.getElementById('loss-progress-text').textContent =
                `共 ${data.total} 笔亏损交易，开始分析...`;
            break;

        case 'progress':
            document.getElementById('loss-progress-text').textContent = data.message;
            break;

        case 'stock_analysis':
            appendStockAnalysisCard(data);
            break;

        case 'strategy_summary':
            renderStrategySummary(data.summary);
            break;

        case 'complete':
            document.getElementById('loss-analysis-progress').classList.add('hidden');
            break;

        case 'error':
            document.getElementById('loss-analysis-progress').classList.add('hidden');
            alert(data.message);
            break;
    }
}

function appendStockAnalysisCard(a) {
    const container = document.getElementById('loss-analysis-results');

    // Board data display
    let boardHtml = '<span class="la-no-data">板块数据不可用</span>';
    const bd = a.board_data;
    if (bd && !bd.error) {
        boardHtml = `
            <div class="la-board-grid">
                ${bd.open_gain != null ? `<span class="la-board-item">开盘 <strong>${fmtGain(bd.open_gain)}</strong></span>` : ''}
                ${bd.gain_940 != null ? `<span class="la-board-item">9:40 <strong>${fmtGain(bd.gain_940)}</strong></span>` : ''}
                ${bd.day_gain != null ? `<span class="la-board-item">全天 <strong>${fmtGain(bd.day_gain)}</strong></span>` : ''}
                ${bd.max_gain != null ? `<span class="la-board-item">最高 <strong>${fmtGain(bd.max_gain)}</strong></span>` : ''}
                ${bd.min_gain != null ? `<span class="la-board-item">最低 <strong>${fmtGain(bd.min_gain)}</strong></span>` : ''}
            </div>
        `;
    } else if (bd && bd.error) {
        boardHtml = `<span class="la-no-data">${bd.error}</span>`;
    }

    // Stock day data
    let stockDayHtml = '';
    const sd = a.stock_day_data;
    if (sd && sd.prev_close) {
        stockDayHtml = `
            <div class="la-stock-day">
                <span>个股当日：</span>
                <span>开盘 <strong>${fmtGain(sd.open_gain)}</strong></span>
                <span>全天 <strong>${fmtGain(sd.day_gain)}</strong></span>
                <span>最高 <strong>${fmtGain(sd.max_gain)}</strong></span>
                <span>最低 <strong>${fmtGain(sd.min_gain)}</strong></span>
            </div>
        `;
    }

    // Trigger codes
    const triggers = (a.trigger_codes || []).join(', ') || '无';

    const card = document.createElement('div');
    card.className = 'la-card';
    card.innerHTML = `
        <div class="la-card-header">
            <div class="la-stock-info">
                <span class="stock-code">${a.stock_code}</span>
                <span class="la-stock-name">${a.stock_name}</span>
                <span class="la-board-tag">${a.board_name}</span>
            </div>
            <div class="la-loss-info">
                <span class="la-loss-amount">${a.profit >= 0 ? '+' : ''}${a.profit.toFixed(2)}元</span>
                <span class="la-loss-pct">${a.return_pct >= 0 ? '+' : ''}${a.return_pct.toFixed(2)}%</span>
            </div>
        </div>
        <div class="la-card-meta">
            <span>买入 ${a.trade_date} @ ${a.buy_price}</span>
            <span>卖出 ${a.sell_date} @ ${a.sell_price}</span>
            <span>触发股: ${triggers}</span>
        </div>
        <div class="la-section">
            <div class="la-section-title">板块走势 (${a.board_name})</div>
            ${boardHtml}
        </div>
        ${stockDayHtml}
        <div class="la-section">
            <div class="la-section-title">AI 分析</div>
            <div class="la-llm-text">${a.llm_analysis || '分析中...'}</div>
        </div>
    `;
    container.appendChild(card);
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderStrategySummary(summary) {
    const el = document.getElementById('loss-analysis-summary');
    el.classList.remove('hidden');
    el.innerHTML = `
        <div class="la-summary">
            <div class="la-summary-title">策略总结</div>
            <div class="la-summary-text">${summary.replace(/\n/g, '<br>')}</div>
        </div>
    `;
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function fmtGain(val) {
    if (val == null) return '-';
    const cls = val > 0 ? 'range-profit-pos' : (val < 0 ? 'range-profit-neg' : '');
    return `<span class="${cls}">${val >= 0 ? '+' : ''}${val.toFixed(2)}%</span>`;
}

// === Funnel Analysis ===
const LAYER_NAMES = ['L0: 全部成分股', 'L1: 涨幅>0.56%', 'L2: PE过滤', 'L3: 高开低走过滤', 'L4: 最终推荐'];

document.getElementById('funnel-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const startDate = document.getElementById('funnel_start').value;
    const endDate = document.getElementById('funnel_end').value;
    const fadeFilter = document.getElementById('funnel_fade').checked;

    if (!startDate || !endDate) return;
    if (endDate < startDate) { alert('结束日期不能早于起始日期'); return; }

    // Reset UI
    document.getElementById('funnel-loading').classList.remove('hidden');
    document.getElementById('funnel-results').classList.add('hidden');
    document.getElementById('funnel-summary-body').innerHTML = '';
    document.getElementById('funnel-day-body').innerHTML = '';
    document.getElementById('funnel-conclusions').innerHTML = '';
    document.getElementById('funnel-btn').disabled = true;
    document.getElementById('funnel-btn').textContent = '分析中...';

    try {
        const resp = await fetch('/api/momentum/funnel-analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start_date: startDate,
                end_date: endDate,
                fade_filter: fadeFilter,
            }),
        });

        if (!resp.ok) {
            const errData = await resp.json();
            alert(errData.detail || '分析失败');
            return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const messages = buffer.split('\n\n');
            buffer = messages.pop();

            for (const msg of messages) {
                const trimmed = msg.trim();
                if (!trimmed.startsWith('data: ')) continue;
                try {
                    const data = JSON.parse(trimmed.substring(6));
                    handleFunnelEvent(data);
                } catch (parseErr) {}
            }
        }

        if (buffer.trim().startsWith('data: ')) {
            try {
                const data = JSON.parse(buffer.trim().substring(6));
                handleFunnelEvent(data);
            } catch (e) {}
        }

    } catch (err) {
        alert('请求失败: ' + err.message);
    } finally {
        document.getElementById('funnel-loading').classList.add('hidden');
        document.getElementById('funnel-btn').disabled = false;
        document.getElementById('funnel-btn').textContent = '开始分析';
    }
});

function handleFunnelEvent(data) {
    switch (data.type) {
        case 'init':
            document.getElementById('funnel-progress-hint').textContent =
                `${data.start_date} ~ ${data.end_date}，共 ${data.total_days} 个交易日`;
            break;

        case 'warning':
            document.getElementById('funnel-progress-hint').textContent = data.message;
            break;

        case 'progress': {
            document.getElementById('funnel-progress-text').textContent =
                `正在处理第 ${data.day} / ${data.total} 天 (${data.trade_date})...`;
            const pct = (data.day / data.total * 100).toFixed(0);
            document.getElementById('funnel-progress-fill').style.width = pct + '%';
            break;
        }

        case 'day_skip':
            appendFunnelDayRow(data.trade_date, null, data.reason);
            break;

        case 'day_result':
            document.getElementById('funnel-results').classList.remove('hidden');
            appendFunnelDayRow(data.trade_date, data.layers, null);
            break;

        case 'complete':
            document.getElementById('funnel-loading').classList.add('hidden');
            renderFunnelSummary(data.summary, data.conclusions);
            break;

        case 'error':
            document.getElementById('funnel-loading').classList.add('hidden');
            alert(data.message);
            break;
    }
}

function appendFunnelDayRow(tradeDate, layers, skipReason) {
    const tbody = document.getElementById('funnel-day-body');
    const tr = document.createElement('tr');

    if (!layers) {
        tr.className = 'range-skip-row';
        tr.innerHTML = `<td>${tradeDate}</td><td colspan="5" class="range-skip-reason">${skipReason || '跳过'}</td>`;
    } else {
        let cells = `<td>${tradeDate}</td>`;
        for (const ln of LAYER_NAMES) {
            const l = layers[ln];
            if (l && l.count > 0) {
                const retClass = l.avg_return > 0 ? 'range-profit-pos' : (l.avg_return < 0 ? 'range-profit-neg' : '');
                cells += `<td><span class="funnel-cell-count">${l.count}</span> <span class="${retClass}">${l.avg_return >= 0 ? '+' : ''}${l.avg_return.toFixed(2)}%</span></td>`;
            } else {
                cells += `<td class="range-skip-reason">-</td>`;
            }
        }
        tr.innerHTML = cells;
    }
    tbody.appendChild(tr);
}

function renderFunnelSummary(summary, conclusions) {
    const tbody = document.getElementById('funnel-summary-body');
    tbody.innerHTML = '';

    let prevReturn = null;
    for (const ln of LAYER_NAMES) {
        const s = summary[ln];
        if (!s) continue;

        const tr = document.createElement('tr');
        const retClass = s.avg_return > 0 ? 'range-profit-pos' : (s.avg_return < 0 ? 'range-profit-neg' : '');
        const medClass = s.median_return > 0 ? 'range-profit-pos' : (s.median_return < 0 ? 'range-profit-neg' : '');

        // Effect indicator
        let effectHtml = '-';
        if (prevReturn !== null && s.avg_count > 0) {
            const diff = s.avg_return - prevReturn;
            if (diff > 0.05) {
                effectHtml = `<span class="funnel-effect-pos">+${diff.toFixed(2)}%</span>`;
            } else if (diff < -0.05) {
                effectHtml = `<span class="funnel-effect-neg">${diff.toFixed(2)}%</span>`;
            } else {
                effectHtml = `<span class="funnel-effect-neutral">${diff >= 0 ? '+' : ''}${diff.toFixed(2)}%</span>`;
            }
        }
        prevReturn = s.avg_count > 0 ? s.avg_return : prevReturn;

        tr.innerHTML = `
            <td class="funnel-layer-name">${ln}</td>
            <td>${s.avg_count.toFixed(1)}</td>
            <td class="${retClass}">${s.avg_return >= 0 ? '+' : ''}${s.avg_return.toFixed(2)}%</td>
            <td>${s.win_rate.toFixed(1)}%</td>
            <td class="${medClass}">${s.median_return >= 0 ? '+' : ''}${s.median_return.toFixed(2)}%</td>
            <td>${effectHtml}</td>
        `;
        tbody.appendChild(tr);
    }

    // Render conclusions
    if (conclusions && conclusions.length > 0) {
        const el = document.getElementById('funnel-conclusions');
        let html = '<div class="funnel-conclusion-box"><strong>结论:</strong><ul>';
        for (const c of conclusions) {
            let icon, cls;
            if (c.verdict === 'positive') { icon = '^'; cls = 'range-profit-pos'; }
            else if (c.verdict === 'negative') { icon = '!!'; cls = 'range-profit-neg'; }
            else { icon = '-'; cls = ''; }
            html += `<li class="${cls}">${c.filter}: 收益 ${c.prev_return >= 0 ? '+' : ''}${c.prev_return.toFixed(2)}% -> ${c.curr_return >= 0 ? '+' : ''}${c.curr_return.toFixed(2)}% (${c.diff >= 0 ? '+' : ''}${c.diff.toFixed(2)}%) ${icon === '!!' ? '疑似负面过滤!' : icon === '^' ? '有效过滤' : '影响不大'}</li>`;
        }
        html += '</ul></div>';
        el.innerHTML = html;
    }
}
</script>
{% endblock %}
