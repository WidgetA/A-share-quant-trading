{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="settings-page">
    <h2>Settings</h2>

    <!-- iFinD Token Section -->
    <section class="settings-section">
        <div class="settings-card">
            <h3>iFinD Refresh Token</h3>
            <p class="settings-desc">用于 iFinD HTTP API 认证。从 iFinD Windows 客户端获取：工具 → refresh_token 查询/更新</p>

            <!-- Current Status -->
            <div class="token-status" id="tokenStatus">
                <span class="token-status-label">当前状态：</span>
                <span class="token-status-value" id="tokenStatusValue">加载中...</span>
            </div>

            <!-- Token Input -->
            <div class="form-group">
                <label for="tokenInput">新 Token</label>
                <textarea id="tokenInput" class="token-input" rows="3"
                    placeholder="粘贴 refresh_token..."></textarea>
            </div>

            <!-- Actions -->
            <div class="token-actions">
                <button class="btn btn-secondary" onclick="testToken()" id="testBtn">验证 Token</button>
                <button class="btn btn-primary" onclick="saveToken()" id="saveBtn">保存</button>
            </div>

            <!-- Result Message -->
            <div class="token-message hidden" id="tokenMessage"></div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load current token status on page load
async function loadTokenStatus() {
    try {
        const resp = await fetch('/api/settings/ifind-token');
        const data = await resp.json();
        const el = document.getElementById('tokenStatusValue');
        if (data.configured) {
            el.textContent = `${data.source_label} | ${data.masked_token} (${data.token_length} 字符)`;
            el.className = 'token-status-value configured';
        } else {
            el.textContent = '未配置';
            el.className = 'token-status-value not-configured';
        }
    } catch (e) {
        document.getElementById('tokenStatusValue').textContent = '加载失败';
    }
}

function showMessage(text, success) {
    const el = document.getElementById('tokenMessage');
    el.textContent = text;
    el.className = 'token-message ' + (success ? 'success' : 'error');
}

async function testToken() {
    const token = document.getElementById('tokenInput').value.trim();
    if (!token) {
        showMessage('请先输入 Token', false);
        return;
    }

    const btn = document.getElementById('testBtn');
    btn.disabled = true;
    btn.textContent = '验证中...';
    showMessage('', true);

    try {
        const resp = await fetch('/api/settings/ifind-token/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: token})
        });
        const data = await resp.json();
        showMessage(data.message, data.success);
    } catch (e) {
        showMessage('请求失败: ' + e.message, false);
    } finally {
        btn.disabled = false;
        btn.textContent = '验证 Token';
    }
}

async function saveToken() {
    const token = document.getElementById('tokenInput').value.trim();
    if (!token) {
        showMessage('请先输入 Token', false);
        return;
    }

    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.textContent = '保存中...';

    try {
        const resp = await fetch('/api/settings/ifind-token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: token})
        });
        const data = await resp.json();
        if (resp.ok && data.success) {
            showMessage(data.message, true);
            document.getElementById('tokenInput').value = '';
            loadTokenStatus();
        } else {
            showMessage(data.detail || data.message || '保存失败', false);
        }
    } catch (e) {
        showMessage('请求失败: ' + e.message, false);
    } finally {
        btn.disabled = false;
        btn.textContent = '保存';
    }
}

loadTokenStatus();
</script>
{% endblock %}
