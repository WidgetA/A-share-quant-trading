{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="settings-page">
    <h2>Settings</h2>

    <!-- iFinD Token Section -->
    <section class="settings-section">
        <div class="settings-card">
            <h3>iFinD Refresh Token</h3>
            <p class="settings-desc">用于 iFinD HTTP API 认证。从 iFinD Windows 客户端获取：工具 → refresh_token 查询/更新</p>

            <!-- Current Status -->
            <div class="token-status" id="tokenStatus">
                <span class="token-status-label">当前状态：</span>
                <span class="token-status-value" id="tokenStatusValue">加载中...</span>
            </div>

            <!-- Token Input -->
            <div class="form-group">
                <label for="tokenInput">新 Token</label>
                <textarea id="tokenInput" class="token-input" rows="3"
                    placeholder="粘贴 refresh_token..."></textarea>
            </div>

            <!-- Actions -->
            <div class="token-actions">
                <button class="btn btn-secondary" onclick="testToken()" id="testBtn">验证 Token</button>
                <button class="btn btn-primary" onclick="saveToken()" id="saveBtn">保存</button>
            </div>

            <!-- Result Message -->
            <div class="token-message hidden" id="tokenMessage"></div>
        </div>
    </section>

    <!-- Tavily API Key Section -->
    <section class="settings-section">
        <div class="settings-card">
            <h3>Tavily API Key</h3>
            <p class="settings-desc">用于动量策略 Step 6 利空新闻搜索。免费额度 1000 次/月，注册：<a href="https://tavily.com" target="_blank">tavily.com</a></p>

            <!-- Current Status -->
            <div class="token-status" id="tavilyStatus">
                <span class="token-status-label">当前状态：</span>
                <span class="token-status-value" id="tavilyStatusValue">加载中...</span>
            </div>

            <!-- Key Input -->
            <div class="form-group">
                <label for="tavilyInput">API Key</label>
                <input type="text" id="tavilyInput" class="token-input"
                    placeholder="tvly-xxxxxxxxxxxxxxxx" style="font-family: monospace;">
            </div>

            <!-- Actions -->
            <div class="token-actions">
                <button class="btn btn-secondary" onclick="testTavilyKey()" id="tavilyTestBtn">验证 Key</button>
                <button class="btn btn-primary" onclick="saveTavilyKey()" id="tavilySaveBtn">保存</button>
            </div>

            <!-- Result Message -->
            <div class="token-message hidden" id="tavilyMessage"></div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// === iFinD Token ===
async function loadTokenStatus() {
    try {
        const resp = await fetch('/api/settings/ifind-token');
        const data = await resp.json();
        const el = document.getElementById('tokenStatusValue');
        if (data.configured) {
            el.textContent = `${data.source_label} | ${data.masked_token} (${data.token_length} 字符)`;
            el.className = 'token-status-value configured';
        } else {
            el.textContent = '未配置';
            el.className = 'token-status-value not-configured';
        }
    } catch (e) {
        document.getElementById('tokenStatusValue').textContent = '加载失败';
    }
}

function showMessage(elId, text, success) {
    const el = document.getElementById(elId);
    if (typeof text === 'object' && text !== null) {
        text = JSON.stringify(text);
    }
    el.textContent = text || '';
    el.className = 'token-message ' + (success ? 'success' : 'error');
}

async function testToken() {
    const token = document.getElementById('tokenInput').value.trim();
    if (!token) {
        showMessage('tokenMessage', '请先输入 Token', false);
        return;
    }

    const btn = document.getElementById('testBtn');
    btn.disabled = true;
    btn.textContent = '验证中...';
    showMessage('tokenMessage', '', true);

    try {
        const resp = await fetch('/api/settings/ifind-token/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: token})
        });
        const data = await resp.json();
        showMessage('tokenMessage', data.message || data.detail || '未知响应', data.success);
    } catch (e) {
        showMessage('tokenMessage', '请求失败: ' + (e.message || e), false);
    } finally {
        btn.disabled = false;
        btn.textContent = '验证 Token';
    }
}

async function saveToken() {
    const token = document.getElementById('tokenInput').value.trim();
    if (!token) {
        showMessage('tokenMessage', '请先输入 Token', false);
        return;
    }

    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.textContent = '保存中...';

    try {
        const resp = await fetch('/api/settings/ifind-token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: token})
        });
        const data = await resp.json();
        if (resp.ok && data.success) {
            showMessage('tokenMessage', data.message, true);
            document.getElementById('tokenInput').value = '';
            loadTokenStatus();
        } else {
            const errMsg = typeof data.detail === 'string' ? data.detail : data.message || '保存失败';
            showMessage('tokenMessage', errMsg, false);
        }
    } catch (e) {
        showMessage('tokenMessage', '请求失败: ' + e.message, false);
    } finally {
        btn.disabled = false;
        btn.textContent = '保存';
    }
}

// === Tavily API Key ===
async function loadTavilyStatus() {
    try {
        const resp = await fetch('/api/settings/tavily-key');
        const data = await resp.json();
        const el = document.getElementById('tavilyStatusValue');
        if (data.configured) {
            el.textContent = `${data.source_label} | ${data.masked_key} (${data.key_length} 字符)`;
            el.className = 'token-status-value configured';
        } else {
            el.textContent = '未配置';
            el.className = 'token-status-value not-configured';
        }
    } catch (e) {
        document.getElementById('tavilyStatusValue').textContent = '加载失败';
    }
}

async function testTavilyKey() {
    const key = document.getElementById('tavilyInput').value.trim();
    if (!key) {
        showMessage('tavilyMessage', '请先输入 API Key', false);
        return;
    }

    const btn = document.getElementById('tavilyTestBtn');
    btn.disabled = true;
    btn.textContent = '验证中...';
    showMessage('tavilyMessage', '', true);

    try {
        const resp = await fetch('/api/settings/tavily-key/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: key})
        });
        const data = await resp.json();
        showMessage('tavilyMessage', data.message || data.detail || '未知响应', data.success);
    } catch (e) {
        showMessage('tavilyMessage', '请求失败: ' + (e.message || e), false);
    } finally {
        btn.disabled = false;
        btn.textContent = '验证 Key';
    }
}

async function saveTavilyKey() {
    const key = document.getElementById('tavilyInput').value.trim();
    if (!key) {
        showMessage('tavilyMessage', '请先输入 API Key', false);
        return;
    }

    const btn = document.getElementById('tavilySaveBtn');
    btn.disabled = true;
    btn.textContent = '保存中...';

    try {
        const resp = await fetch('/api/settings/tavily-key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: key})
        });
        const data = await resp.json();
        if (resp.ok && data.success) {
            showMessage('tavilyMessage', data.message, true);
            document.getElementById('tavilyInput').value = '';
            loadTavilyStatus();
        } else {
            const errMsg = typeof data.detail === 'string' ? data.detail : data.message || '保存失败';
            showMessage('tavilyMessage', errMsg, false);
        }
    } catch (e) {
        showMessage('tavilyMessage', '请求失败: ' + e.message, false);
    } finally {
        btn.disabled = false;
        btn.textContent = '保存';
    }
}

// Load both on page load
loadTokenStatus();
loadTavilyStatus();
</script>
{% endblock %}
