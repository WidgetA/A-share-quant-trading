{% extends "base.html" %}

{% block title %}历史模拟{% endblock %}

{% block content %}
<div class="simulation-page">
    <h2>历史模拟</h2>

    <!-- Start Form (shown when not running) -->
    <section id="start-section" class="sim-section {% if state.phase != 'not_started' %}hidden{% endif %}">
        <div class="sim-card">
            <h3>开始新模拟</h3>
            <form id="start-form" class="sim-form">
                <div class="form-group">
                    <label for="start_date">模拟开始日期</label>
                    <input type="date" id="start_date" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="num_days">模拟天数</label>
                    <select id="num_days" name="num_days">
                        <option value="1">1 天</option>
                        <option value="2" selected>2 天</option>
                        <option value="3">3 天</option>
                        <option value="5">5 天</option>
                    </select>
                </div>
                <div class="form-group" id="capital-group">
                    <label for="initial_capital">初始资金</label>
                    <input type="number" id="initial_capital" name="initial_capital" value="10000000" step="100000">
                </div>
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="load_holdings" name="load_holdings" onchange="toggleCapitalInput()">
                        <span>从数据库加载现有持仓</span>
                    </label>
                    <p class="form-hint">初始资金将设置为持仓市值</p>
                </div>
                <button type="submit" class="btn btn-primary btn-lg">开始模拟</button>
            </form>
        </div>
    </section>

    <!-- Simulation State (shown when running) -->
    <section id="state-section" class="sim-section {% if state.phase == 'not_started' %}hidden{% endif %}">
        <!-- Phase Header -->
        {% set phase_names = {
            'premarket_analysis': '盘前分析',
            'morning_auction': '早盘竞价',
            'trading_hours': '交易时段',
            'market_close': '收盘',
            'morning_confirmation': '次日早盘确认',
            'completed': '模拟完成'
        } %}
        {% set phase_hints = {
            'premarket_analysis': '分析昨夜今晨的消息，选择看好的信号',
            'morning_auction': '执行买入委托',
            'trading_hours': '观察盘中走势',
            'market_close': '当日交易结束，查看收益',
            'morning_confirmation': '决定隔夜持仓是否卖出',
            'completed': '查看最终模拟结果'
        } %}
        {% set sentiment_names = {
            'strong_bullish': '强看多',
            'bullish': '看多',
            'neutral': '中性',
            'bearish': '看空',
            'strong_bearish': '强看空',
            'unknown': '未分析'
        } %}
        <div class="phase-header">
            <div class="phase-info">
                <span class="phase-badge {{ state.phase }}">{{ phase_names.get(state.phase, state.phase) }}</span>
                <span class="phase-hint-text">{{ phase_hints.get(state.phase, '') }}</span>
                <span class="sim-time">{{ state.sim_time[:16] if state.sim_time else '' }}</span>
                <span class="day-counter">第 {{ state.day_number }}/{{ state.total_days }} 天</span>
            </div>
            <button class="btn btn-danger btn-sm" onclick="cancelSimulation()">取消</button>
        </div>

        <!-- Messages Log -->
        <div class="messages-log">
            {% for msg in state.messages %}
            <div class="log-msg">{{ msg }}</div>
            {% endfor %}
        </div>

        <!-- Premarket: Signal Selection -->
        {% if state.phase == 'premarket_analysis' and state.pending_signals %}
        <div class="sim-card">
            <h3>选择要买入的消息</h3>
            <p class="phase-description">以下是当日所有消息，绿色为AI推荐的正面消息，您可以选择任何消息进行买入</p>
            <form id="select-form" class="signals-form">
                {% for signal in state.pending_signals %}
                {% set is_positive = signal.sentiment in ['strong_bullish', 'bullish'] %}
                <div class="signal-item {{ signal.sentiment }} {% if is_positive %}recommended{% endif %}">
                    <label class="signal-checkbox">
                        <input type="checkbox" name="signals" value="{{ signal.index }}" {% if is_positive %}checked{% endif %}>
                        <div class="signal-content">
                            <div class="signal-header">
                                <span class="signal-index">#{{ signal.index }}</span>
                                {% if signal.publish_time %}
                                <span class="signal-time">{{ signal.publish_time[11:16] }}</span>
                                {% endif %}
                                <span class="signal-sentiment {{ signal.sentiment }}">{{ sentiment_names.get(signal.sentiment, signal.sentiment) }}</span>
                                {% if signal.confidence > 0 %}
                                <span class="signal-confidence">置信度 {{ "%.0f"|format(signal.confidence * 100) }}%</span>
                                {% endif %}
                                {% if is_positive %}
                                <span class="ai-recommended">AI推荐</span>
                                {% endif %}
                            </div>
                            <div class="signal-title">{{ signal.title }}</div>
                            <div class="signal-stocks">
                                {% for stock in signal.target_stocks[:5] %}
                                <span class="stock-tag">{{ stock }}{% if signal.target_stock_names and signal.target_stock_names.get(stock.split('.')[0] if '.' in stock else stock) %} {{ signal.target_stock_names.get(stock.split('.')[0] if '.' in stock else stock) }}{% endif %}</span>
                                {% endfor %}
                                {% if signal.target_stocks|length > 5 %}
                                <span class="stock-tag more">+{{ signal.target_stocks|length - 5 }}</span>
                                {% endif %}
                            </div>
                            {% if signal.reasoning %}
                            <div class="signal-reasoning">{{ signal.reasoning[:150] }}{% if signal.reasoning|length > 150 %}...{% endif %}</div>
                            {% endif %}
                        </div>
                    </label>
                </div>
                {% endfor %}
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">确认选择</button>
                    <button type="button" class="btn btn-secondary" onclick="skipSelection()">跳过（不买入）</button>
                </div>
            </form>
        </div>
        {% elif state.phase == 'premarket_analysis' %}
        <div class="sim-card">
            <p>当日无新消息</p>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="advancePhase()">生成信号</button>
                <button class="btn btn-secondary" onclick="skipSelection()">跳过到下一阶段</button>
            </div>
        </div>
        {% endif %}

        <!-- Sell Decision: At Market Close or Morning Confirmation -->
        {% if state.phase in ['market_close', 'morning_confirmation'] and state.pending_holdings %}
        <div class="sim-card">
            <h3>{% if state.phase == 'market_close' %}收盘 - 卖出还是持有？{% else %}早盘确认 - 卖出还是持有？{% endif %}</h3>
            <p class="phase-description">
                {% if state.phase == 'market_close' %}
                策略建议：持仓不过夜。勾选要卖出的持仓（将以收盘价卖出）
                {% else %}
                以下是您的隔夜持仓，勾选要卖出的持仓（将以次日开盘价卖出）
                {% endif %}
            </p>
            <form id="sell-form" class="holdings-form">
                {% for holding in state.pending_holdings %}
                <div class="holding-item">
                    <label class="holding-checkbox">
                        <input type="checkbox" name="slots" value="{{ holding.slot_id }}">
                        <div class="holding-content">
                            <div class="holding-header">
                                <span class="stock-code">{{ holding.stock_code }}</span>
                                <span class="stock-name">{{ holding.stock_name }}</span>
                            </div>
                            <div class="holding-details">
                                <span>数量: {{ holding.quantity }} 股</span>
                                <span>成本: {{ "%.2f"|format(holding.entry_price) }}</span>
                                {% if holding.current_price %}
                                <span>现价: {{ "%.2f"|format(holding.current_price) }}</span>
                                {% endif %}
                                {% if holding.pnl_percent is not none %}
                                <span class="pnl {{ 'positive' if holding.pnl_percent > 0 else 'negative' }}">
                                    {{ "%+.2f"|format(holding.pnl_percent) }}%
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </label>
                </div>
                {% endfor %}
                <div class="form-actions">
                    <button type="submit" class="btn btn-danger">
                        {% if state.phase == 'market_close' %}卖出选中（收盘价）{% else %}卖出选中（次日开盘价）{% endif %}
                    </button>
                    <button type="button" class="btn btn-success" onclick="holdAll()">全部持有</button>
                </div>
            </form>
        </div>
        {% endif %}

        <!-- Morning Auction phase -->
        {% if state.phase == 'morning_auction' %}
        <div class="sim-card">
            <h3>早盘竞价 - 执行买入委托</h3>
            <p class="phase-description">点击下方按钮以开盘价执行买入委托</p>
            <button class="btn btn-primary btn-lg" onclick="advancePhase()">执行买入</button>
        </div>
        {% endif %}

        <!-- Trading Hours phase with intraday messages -->
        {% if state.phase == 'trading_hours' %}
        <div class="sim-card" id="trading-hours-main">
            <h3>交易时段 ({{ state.sim_time[11:16] if state.sim_time else '09:30' }})</h3>
            {% if state.intraday_signals %}
            <p class="phase-description">发现 {{ state.intraday_signals|length }} 条盘中消息，您可以选择买入或跳过</p>
            <form id="intraday-form" class="signals-form">
                {% for signal in state.intraday_signals %}
                {% set is_positive = signal.sentiment in ['strong_bullish', 'bullish'] %}
                <div class="signal-item {{ signal.sentiment }} {% if is_positive %}recommended{% endif %}">
                    <label class="signal-checkbox">
                        <input type="checkbox" name="signals" value="{{ signal.index }}" {% if is_positive %}checked{% endif %}>
                        <div class="signal-content">
                            <div class="signal-header">
                                <span class="signal-index">#{{ signal.index }}</span>
                                {% if signal.publish_time %}
                                <span class="signal-time">{{ signal.publish_time[11:16] }}</span>
                                {% endif %}
                                <span class="signal-sentiment {{ signal.sentiment }}">{{ sentiment_names.get(signal.sentiment, signal.sentiment) }}</span>
                                {% if signal.confidence > 0 %}
                                <span class="signal-confidence">置信度 {{ "%.0f"|format(signal.confidence * 100) }}%</span>
                                {% endif %}
                                {% if is_positive %}
                                <span class="ai-recommended">AI推荐</span>
                                {% endif %}
                            </div>
                            <div class="signal-title">{{ signal.title }}</div>
                            <div class="signal-stocks">
                                {% for stock in signal.target_stocks[:5] %}
                                <span class="stock-tag">{{ stock }}{% if signal.target_stock_names and signal.target_stock_names.get(stock.split('.')[0] if '.' in stock else stock) %} {{ signal.target_stock_names.get(stock.split('.')[0] if '.' in stock else stock) }}{% endif %}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </label>
                </div>
                {% endfor %}
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">买入选中</button>
                    <button type="button" class="btn btn-secondary" onclick="skipIntraday()">跳过，不买入</button>
                </div>
            </form>
            {% else %}
            <p class="phase-description">当前处于交易时段。您可以：</p>
            <ul class="phase-options">
                <li>点击"查看消息"浏览所有消息并选择买入</li>
                <li>点击"检查盘中消息"查看是否有新的盘中消息</li>
                <li>点击"快进到收盘"直接跳到15:00收盘</li>
            </ul>
            <div class="form-actions trading-actions">
                <button class="btn btn-secondary" onclick="showMessages()">查看消息</button>
                <button class="btn btn-primary" onclick="advancePhase()">检查盘中消息</button>
                <button class="btn btn-outline" onclick="fastForwardToClose()">快进到收盘</button>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Market Close phase (only show if no pending sell decision) -->
        {% if state.phase == 'market_close' and not state.pending_holdings %}
        <div class="sim-card">
            <h3>收盘</h3>
            <p class="phase-description">当日交易结束</p>
            <button class="btn btn-primary btn-lg" onclick="advancePhase()">
                {% if state.day_number < state.total_days %}
                进入下一交易日
                {% else %}
                查看结果
                {% endif %}
            </button>
        </div>
        {% endif %}

        <!-- Current Holdings -->
        {% if state.holdings %}
        <div class="sim-card">
            <h3>当前持仓</h3>
            <div class="holdings-table">
                {% for h in state.holdings %}
                <div class="holding-row">
                    <span class="stock-code">{{ h.stock_code }}</span>
                    <span class="stock-name">{{ h.stock_name or '' }}</span>
                    <span class="quantity">{{ h.quantity }} 股</span>
                    <span class="entry-price">成本 {{ "%.2f"|format(h.entry_price) }}</span>
                    {% if h.current_price %}
                    <span class="current-price">现价 {{ "%.2f"|format(h.current_price) }}</span>
                    {% endif %}
                    {% if h.pnl_percent is not none %}
                    <span class="pnl {{ 'positive' if h.pnl_percent > 0 else 'negative' }}">
                        {{ "%+.2f"|format(h.pnl_percent) }}%
                    </span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Completed: Show Results -->
        {% if state.phase == 'completed' %}
        <div class="sim-card results-card">
            <h3>模拟完成！</h3>
            <div class="results-actions">
                <button class="btn btn-primary btn-lg" onclick="showResults()">查看最终结果</button>
                {% if state.can_sync_to_db and not state.is_synced %}
                <button class="btn btn-warning btn-lg" onclick="confirmSyncToDb()">更新到数据库</button>
                {% elif state.is_synced %}
                <span class="sync-status success">✓ 已同步到数据库</span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Capital Info -->
        <div class="capital-info">
            <span>初始资金: {{ "{:,.0f}".format(state.initial_capital) }}</span>
            <span>可用现金: {{ "{:,.0f}".format(state.available_cash) }}</span>
            <button class="btn btn-sm btn-secondary" onclick="showMessages()">查看消息</button>
        </div>
    </section>

    <!-- Results Modal -->
    <div id="results-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>模拟结果</h3>
                <button class="modal-close" onclick="closeResults()">&times;</button>
            </div>
            <div class="modal-body" id="results-content">
                加载中...
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="resetSimulation()">开始新模拟</button>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messages-modal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>历史消息</h3>
                <button class="modal-close" onclick="closeMessages()">&times;</button>
            </div>
            <div class="modal-body" id="messages-content">
                <div class="messages-filter">
                    <label>
                        <input type="checkbox" id="only-positive" onchange="loadMessages()">
                        仅显示正面消息
                    </label>
                </div>
                <div id="messages-list">加载中...</div>
            </div>
            <div class="modal-footer messages-actions" id="messages-actions" style="display: none;">
                <button class="btn btn-primary" onclick="confirmMessageSelection()">确认选择</button>
                <span class="selection-count">已选 <span id="msg-selected-count">0</span> 条</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const startForm = document.getElementById('start-form');
const selectForm = document.getElementById('select-form');
const sellForm = document.getElementById('sell-form');
const intradayForm = document.getElementById('intraday-form');

// Start simulation
if (startForm) {
    startForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(startForm);
        const loadHoldings = document.getElementById('load_holdings').checked;

        const data = {
            start_date: formData.get('start_date'),
            num_days: parseInt(formData.get('num_days')),
            initial_capital: parseFloat(formData.get('initial_capital'))
        };

        // If loading holdings, use today's date as the reference
        if (loadHoldings) {
            data.load_holdings_from = formData.get('start_date');
        }

        try {
            const response = await fetch('/api/simulation/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok && result.success) {
                window.location.reload();
            } else {
                alert('错误: ' + (result.detail || result.message || '未知错误'));
            }
        } catch (error) {
            alert('网络错误: ' + error.message);
        }
    });
}

// Select signals
if (selectForm) {
    selectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const checkboxes = selectForm.querySelectorAll('input[name="signals"]:checked');
        const selected = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (selected.length === 0) {
            if (!confirm('未选择任何信号，确定跳过吗？')) {
                return;
            }
        }

        try {
            const response = await fetch('/api/simulation/select', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_indices: selected })
            });
            const result = await response.json();
            if (response.ok) {
                window.location.reload();
            } else {
                alert('错误: ' + (result.detail || '未知错误'));
            }
        } catch (error) {
            alert('网络错误: ' + error.message);
        }
    });
}

// Skip selection
async function skipSelection() {
    try {
        const response = await fetch('/api/simulation/select', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selected_indices: [] })
        });
        if (response.ok) {
            window.location.reload();
        }
    } catch (error) {
        alert('错误: ' + error.message);
    }
}

// Sell decision
if (sellForm) {
    sellForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const checkboxes = sellForm.querySelectorAll('input[name="slots"]:checked');
        const slots = Array.from(checkboxes).map(cb => parseInt(cb.value));

        try {
            const response = await fetch('/api/simulation/sell', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ slots_to_sell: slots })
            });
            if (response.ok) {
                await advancePhase();
            } else {
                const result = await response.json();
                alert('错误: ' + (result.detail || '未知错误'));
            }
        } catch (error) {
            alert('网络错误: ' + error.message);
        }
    });
}

// Hold all
async function holdAll() {
    try {
        const response = await fetch('/api/simulation/sell', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slots_to_sell: [] })
        });
        if (response.ok) {
            await advancePhase();
        }
    } catch (error) {
        alert('错误: ' + error.message);
    }
}

// Intraday form submission
if (intradayForm) {
    intradayForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const checkboxes = intradayForm.querySelectorAll('input[name="signals"]:checked');
        const selected = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (selected.length === 0) {
            if (!confirm('未选择任何盘中信号，确定跳过吗？')) {
                return;
            }
            await skipIntraday();
            return;
        }

        try {
            const response = await fetch('/api/simulation/intraday/select', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_indices: selected })
            });
            if (response.ok) {
                window.location.reload();
            } else {
                const result = await response.json();
                alert('错误: ' + (result.detail || '未知错误'));
            }
        } catch (error) {
            alert('网络错误: ' + error.message);
        }
    });
}

// Skip intraday messages
async function skipIntraday() {
    try {
        const response = await fetch('/api/simulation/intraday/skip', {
            method: 'POST'
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const result = await response.json();
            alert('错误: ' + (result.detail || '未知错误'));
        }
    } catch (error) {
        alert('网络错误: ' + error.message);
    }
}

// Fast forward to market close (skip checking intraday messages)
async function fastForwardToClose() {
    try {
        // First skip any pending intraday messages
        await fetch('/api/simulation/intraday/skip', { method: 'POST' });
        // Then advance to close
        const response = await fetch('/api/simulation/advance', { method: 'POST' });
        if (response.ok) {
            window.location.reload();
        } else {
            const result = await response.json();
            alert('错误: ' + (result.detail || '未知错误'));
        }
    } catch (error) {
        alert('网络错误: ' + error.message);
    }
}

// Sync to database with confirmation
async function confirmSyncToDb() {
    const confirmed = confirm(
        '确定要将模拟结果同步到数据库吗？\n\n' +
        '这将覆盖当前数据库中的持仓数据！\n\n' +
        '此操作不可撤销。'
    );

    if (!confirmed) {
        return;
    }

    // Double confirmation
    const doubleConfirm = confirm(
        '再次确认：这将更新真实的持仓数据！\n\n' +
        '点击"确定"继续同步。'
    );

    if (!doubleConfirm) {
        return;
    }

    try {
        const response = await fetch('/api/simulation/sync?confirm=true', {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert(`同步成功！\n\n已同步 ${result.synced_slots} 个仓位，${result.synced_holdings} 只股票。`);
            window.location.reload();
        } else {
            alert('同步失败：' + (result.detail || '未知错误'));
        }
    } catch (error) {
        alert('网络错误：' + error.message);
    }
}

// Advance phase
async function advancePhase() {
    try {
        const response = await fetch('/api/simulation/advance', {
            method: 'POST'
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const result = await response.json();
            alert('Error: ' + (result.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

// Cancel simulation
async function cancelSimulation() {
    if (!confirm('确定要取消模拟吗？')) {
        return;
    }
    try {
        const response = await fetch('/api/simulation', {
            method: 'DELETE'
        });
        if (response.ok) {
            window.location.reload();
        }
    } catch (error) {
        alert('错误: ' + error.message);
    }
}

// Show results
async function showResults() {
    const modal = document.getElementById('results-modal');
    const content = document.getElementById('results-content');
    modal.classList.remove('hidden');

    try {
        const response = await fetch('/api/simulation/result');
        const result = await response.json();

        if (response.ok) {
            const pnlClass = result.total_pnl >= 0 ? 'positive' : 'negative';
            content.innerHTML = `
                <div class="results-summary">
                    <div class="result-item">
                        <span class="label">模拟期间</span>
                        <span class="value">${result.start_date} ~ ${result.end_date}</span>
                    </div>
                    <div class="result-item">
                        <span class="label">初始资金</span>
                        <span class="value">${result.initial_capital.toLocaleString()}</span>
                    </div>
                    <div class="result-item">
                        <span class="label">最终资金</span>
                        <span class="value">${result.final_capital.toLocaleString()}</span>
                    </div>
                    <div class="result-item highlight">
                        <span class="label">总盈亏</span>
                        <span class="value ${pnlClass}">
                            ${result.total_pnl >= 0 ? '+' : ''}${result.total_pnl.toLocaleString()}
                            (${result.pnl_percent >= 0 ? '+' : ''}${result.pnl_percent.toFixed(2)}%)
                        </span>
                    </div>
                </div>
                <div class="results-transactions">
                    <h4>交易记录 (${result.transactions.length} 笔)</h4>
                    ${result.transactions.map(t => `
                        <div class="transaction-row ${t.action.toLowerCase()}">
                            <span class="action">${t.action === 'BUY' ? '买入' : '卖出'}</span>
                            <span class="stock">${t.stock_code} ${t.stock_name || ''}</span>
                            <span class="qty">${t.quantity} 股</span>
                            <span class="price">@ ${t.price.toFixed(2)}</span>
                            <span class="time">${t.timestamp.substring(0, 16)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            content.innerHTML = `<p class="error">${result.detail || '加载结果失败'}</p>`;
        }
    } catch (error) {
        content.innerHTML = `<p class="error">Error: ${error.message}</p>`;
    }
}

// Close results
function closeResults() {
    document.getElementById('results-modal').classList.add('hidden');
}

// Reset simulation
async function resetSimulation() {
    await cancelSimulation();
}

// Show messages modal
function showMessages() {
    document.getElementById('messages-modal').classList.remove('hidden');
    loadMessages();
}

// Close messages modal
function closeMessages() {
    document.getElementById('messages-modal').classList.add('hidden');
}

// Store loaded messages for selection
let loadedMessages = [];
// Pagination state
let currentOffset = 0;
let pageSize = 50;
let totalCount = 0;
let hasMore = false;
// Track checked message IDs for preservation during re-render
let checkedMessageIds = new Set();
// Store stock names map globally for re-render
let globalStockNamesMap = {};

// Get checked message IDs before re-render
function saveCheckedState() {
    checkedMessageIds.clear();
    document.querySelectorAll('.msg-checkbox:checked').forEach(cb => {
        checkedMessageIds.add(cb.dataset.id);
    });
}

// Restore checked state after re-render
function restoreCheckedState() {
    checkedMessageIds.forEach(id => {
        const checkbox = document.querySelector(`.msg-checkbox[data-id="${id}"]`);
        if (checkbox && !checkbox.disabled) {
            checkbox.checked = true;
        }
    });
}

// Load messages from API (append mode for pagination)
async function loadMessages(append = false) {
    const onlyPositive = document.getElementById('only-positive').checked;
    const listEl = document.getElementById('messages-list');
    const actionsEl = document.getElementById('messages-actions');

    // Reset pagination when filter changes or initial load
    if (!append) {
        currentOffset = 0;
        loadedMessages = [];
        checkedMessageIds.clear();
        globalStockNamesMap = {};
        listEl.innerHTML = '<p>加载中...</p>';
    } else {
        // Save checked state before re-render
        saveCheckedState();
    }

    try {
        const url = `/api/simulation/messages?only_positive=${onlyPositive}&limit=${pageSize}&offset=${currentOffset}`;
        const response = await fetch(url);
        const data = await response.json();

        if (!response.ok) {
            listEl.innerHTML = `<p class="error">${data.detail || '加载消息失败'}</p>`;
            actionsEl.style.display = 'none';
            return;
        }

        // Update pagination state
        totalCount = data.total_count;
        hasMore = data.has_more;

        // Append new messages to existing list
        loadedMessages = loadedMessages.concat(data.messages);

        // Merge stock names
        Object.assign(globalStockNamesMap, data.stock_names || {});

        if (loadedMessages.length === 0) {
            listEl.innerHTML = '<p>当日无消息</p>';
            actionsEl.style.display = 'none';
            return;
        }

        const sentimentNames = {
            'strong_bullish': '强看多',
            'bullish': '看多',
            'neutral': '中性',
            'bearish': '看空',
            'strong_bearish': '强看空',
            'unknown': '未分析'
        };

        // Helper function to format stock code with name
        function formatStock(code) {
            // Remove exchange suffix for lookup
            const cleanCode = code.includes('.') ? code.split('.')[0] : code;
            const name = globalStockNamesMap[cleanCode];
            return name ? `${code}(${name})` : code;
        }

        let html = `<p class="messages-summary">已加载 ${loadedMessages.length} / ${totalCount} 条消息 (${data.sim_date}) - 勾选要买入的消息</p>`;
        html += '<div class="messages-table">';

        for (let i = 0; i < loadedMessages.length; i++) {
            const msg = loadedMessages[i];
            const sentiment = msg.analysis?.sentiment || 'unknown';
            const sentimentLabel = sentimentNames[sentiment] || sentiment;
            const confidence = msg.analysis ? (msg.analysis.confidence * 100).toFixed(0) + '%' : '-';
            const reasoning = msg.analysis?.reasoning || '无分析';
            const stockCodes = msg.analysis?.affected_stocks || msg.stock_codes || [];
            const stocks = stockCodes.map(formatStock).join(', ') || '-';
            const isPositive = sentiment === 'strong_bullish' || sentiment === 'bullish';
            const hasStocks = stockCodes.length > 0;
            // For initial load, auto-check positive messages; for append, preserve state
            const shouldCheck = append ? checkedMessageIds.has(msg.id) : (isPositive && hasStocks);

            html += `
                <div class="message-row ${sentiment}">
                    <label class="message-select-label">
                        <input type="checkbox" class="msg-checkbox" value="${i}"
                               data-id="${msg.id}"
                               data-stocks='${JSON.stringify(stockCodes)}'
                               data-title="${(msg.title || '').replace(/"/g, '&quot;')}"
                               data-sentiment="${sentiment}"
                               ${shouldCheck ? 'checked' : ''}
                               ${!hasStocks ? 'disabled title="无相关股票"' : ''}
                               onchange="updateMsgSelectionCount()">
                        <div class="message-content-wrapper">
                            <div class="message-header">
                                <span class="message-time">${msg.publish_time?.substring(0, 16) || '-'}</span>
                                <span class="message-source">${msg.source_name}</span>
                                <span class="sentiment-badge ${sentiment}">${sentimentLabel}</span>
                                <span class="confidence">${confidence}</span>
                                ${isPositive ? '<span class="ai-recommended">AI推荐</span>' : ''}
                            </div>
                            <div class="message-title">${msg.title || '(无标题)'}</div>
                            <div class="message-stocks">相关股票: ${stocks}</div>
                            <div class="message-reasoning">${reasoning}</div>
                        </div>
                    </label>
                    <details class="message-content-details">
                        <summary>查看内容</summary>
                        <div class="message-content">${msg.content || '(无内容)'}</div>
                    </details>
                </div>
            `;
        }

        // Add "Load More" button if more messages available
        if (hasMore) {
            const remaining = totalCount - loadedMessages.length;
            html += `
                <div class="load-more-container">
                    <button class="btn btn-secondary" onclick="loadMoreMessages()" id="load-more-btn">
                        加载更多 (还有 ${remaining} 条)
                    </button>
                </div>
            `;
        }

        html += '</div>';
        listEl.innerHTML = html;

        // Restore checked state for appended messages
        if (append) {
            restoreCheckedState();
        }

        // Show buy button and update count
        actionsEl.style.display = 'flex';
        updateMsgSelectionCount();

    } catch (error) {
        listEl.innerHTML = `<p class="error">错误: ${error.message}</p>`;
    }
}

// Load more messages (pagination)
async function loadMoreMessages() {
    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = '加载中...';
    }

    currentOffset += pageSize;
    await loadMessages(true);  // append mode
}

// Update selection count
function updateMsgSelectionCount() {
    const checkboxes = document.querySelectorAll('.msg-checkbox:checked');
    document.getElementById('msg-selected-count').textContent = checkboxes.length;
}

// Confirm message selection (updates pending signals, then main page shows for confirmation)
async function confirmMessageSelection() {
    const checkboxes = document.querySelectorAll('.msg-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('请先选择消息');
        return;
    }

    // Collect selected message data
    const selectedMessages = [];
    checkboxes.forEach(cb => {
        selectedMessages.push({
            id: cb.dataset.id,
            stocks: JSON.parse(cb.dataset.stocks),
            title: cb.dataset.title,
            sentiment: cb.dataset.sentiment
        });
    });

    try {
        const response = await fetch('/api/simulation/messages/select', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: selectedMessages })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            // Close modal and reload - main page will show selected signals for confirmation
            closeMessages();
            window.location.reload();
        } else {
            alert('选择失败: ' + (result.detail || '未知错误'));
        }
    } catch (error) {
        alert('网络错误: ' + error.message);
    }
}

// Toggle capital input visibility based on load holdings checkbox
function toggleCapitalInput() {
    const loadHoldings = document.getElementById('load_holdings').checked;
    const capitalGroup = document.getElementById('capital-group');
    if (capitalGroup) {
        capitalGroup.style.display = loadHoldings ? 'none' : 'block';
    }
}

// Set default date to yesterday
document.addEventListener('DOMContentLoaded', () => {
    const dateInput = document.getElementById('start_date');
    if (dateInput && !dateInput.value) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 3);  // Default to 3 days ago
        dateInput.value = yesterday.toISOString().split('T')[0];
    }
    // Initialize capital input visibility
    toggleCapitalInput();
});
</script>
{% endblock %}
